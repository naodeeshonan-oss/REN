<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    :root{--maxw:820px}
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
         max-width:var(--maxw); margin:2rem auto; padding:1rem; line-height:1.65}
    h1{display:flex; align-items:center; gap:.6rem; font-size:clamp(1.4rem, 1.2rem + 1.2vw, 2rem); margin:.2rem 0 1rem}
    h1 .icon{font-size:1.6em}
    .row{display:flex; gap:.6rem; align-items:stretch}
    input[type="text"]{flex:1; padding:.7rem .9rem; font-size:1rem; border:1px solid #bbb; border-radius:.5rem}
    button{padding:.7rem 1rem; font-size:1rem; border:1px solid #999; background:#fff; border-radius:.5rem; cursor:pointer}
    button[disabled]{opacity:.6; cursor:wait}
    .hint{font-size:.92rem; color:#444; background:#fafafa; border:1px dashed #ddd; padding:.7rem .8rem; border-radius:.5rem; margin:.8rem 0}
    .hint strong{color:#222}
    .file-line{margin:.6rem 0}
    .error{color:#b00020; margin:.6rem 0 0}
    #result img{max-width:100%; display:block; margin-top:1rem; border:1px solid #ddd; border-radius:.5rem}
    /* ç”Ÿæˆä¸­ã®ãƒŸãƒ‹ã‚¢ãƒ‹ãƒ¡ï¼ˆçŠ¬ãŒæ­©ãï¼‰ */
    .loader-wrap{height:90px; overflow:hidden; position:relative; border:1px solid #eee; border-radius:.5rem; background:#fff; margin-top:.8rem}
    .runner{position:absolute; top:24px; left:-80px; width:80px; height:48px; font-size:40px; line-height:48px}
    .runner.dog::after{content:"ğŸ•";} .runner.cat::after{content:"ğŸˆ";} .runner.mouse::after{content:"ğŸ­";}
    .runner.run{animation:run 3.6s linear infinite}
    @keyframes run { 0%{transform:translateX(0)} 100%{transform:translateX(calc(var(--maxw) - 40px))} }
    .sub{font-size:.85rem; color:#666}
  </style>
</head>
<body>
  <h1><span class="icon">ğŸ¨</span>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <p class="sub">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ç”»åƒã‚’é¸ã¶ã¨ <strong>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</strong>ã€ç”»åƒãªã—ã¯ <strong>æ–°è¦ä½œæˆ</strong> ã§ã™ã€‚</p>

  <!-- æ¨ªä¸¦ã³ï¼šãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› + ç”Ÿæˆãƒœã‚¿ãƒ³ -->
  <div class="row">
    <input id="prompt" type="text" placeholder="ä¾‹ï¼šå¤ã®æµ·ã§ã¯ã—ã‚ƒãå­çŠ¬ã‚’æ²¹çµµé¢¨ã§">
    <button id="btn">ç”Ÿæˆ</button>
  </div>

  <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
  <div class="file-line">
    <input id="file" type="file" accept="image/jpeg,image/png,image/webp">
  </div>

  <!-- å…ˆã«èª­ã‚“ã§ãŠãâ€œä¿é™ºâ€ã®æ³¨æ„æ›¸ãï¼ˆç´ äººå‘ã‘ã«ç°¡å˜ï¼‰ -->
  <div class="hint">
    <strong>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æ³¨æ„</strong><br>
    ãƒ»ä½¿ãˆã‚‹å½¢å¼ï¼šJPEG / PNG / WebPï¼ˆ<u>PNG ã¯ä¿å­˜ã®ä»•æ–¹ã«ã‚ˆã£ã¦å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™</u>ï¼‰<br>
    ãƒ»å¤±æ•—ä¾‹ï¼š<em>unsupported mimetype: application/octet-stream</em>ï¼ˆæ‹¡å¼µå­ã¯PNGã§ã‚‚ä¸­èº«ãŒç•°å¸¸ï¼‰ / 
      <em>format must be RGBA</em>ï¼ˆé€æ˜æƒ…å ±ãªã—PNGï¼‰<br>
    ãƒ»è§£æ±ºæ³•ï¼šä¸€åº¦ã‚¹ãƒãƒ›ï¼PCã®ç·¨é›†æ©Ÿèƒ½ã§é–‹ã„ã¦ã€Œ<u>åˆ¥åã§ä¿å­˜ â†’ PNG ã‚‚ã—ãã¯ JPEG</u>ã€ã«ã—ç›´ã™ã¨ç›´ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
  </div>

  <!-- ç”Ÿæˆä¸­ã‚¢ãƒ‹ãƒ¡è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="loading" class="loader-wrap" style="display:none">
    <div class="runner dog run"></div>
  </div>

  <div id="result"></div>
  <div id="err" class="error"></div>

<script>
/** ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ â€œã¡ã‚ƒã‚“ã¨ã—ãŸPNGâ€ ã«å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ Base64 ã‚’è¿”ã™ï¼ˆRGBAåŒ–ã§äº‹æ•…ã‚’å›é¿ï¼‰ */
async function fileToPngBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    reader.onload = () => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        // PNGï¼ˆRGBAï¼‰ã§å‡ºåŠ›
        const dataUrl = canvas.toDataURL("image/png");
        resolve(dataUrl.split(",")[1]); // base64éƒ¨åˆ†ã ã‘
      };
      img.onerror = () => reject(new Error("ç”»åƒã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"));
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/** è¦‹ã‚„ã™ã„æ—¥æœ¬èªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ› */
function friendlyError(msg=""){
  const m = String(msg);
  if (m.includes("unsupported mimetype") || m.includes("octet-stream")) {
    return "ã“ã®ç”»åƒã¯å£Šã‚ŒãŸå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ç”»åƒç·¨é›†ã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ã€ŒPNG ã¾ãŸã¯ JPEGã€ã§ä¿å­˜ã—ç›´ã—ã¦ãã ã•ã„ã€‚";
  }
  if (m.includes("format must be") || m.includes("RGBA")) {
    return "PNG ã®å†…éƒ¨å½¢å¼ãŒåŸå› ã§ã™ã€‚ç”»åƒã‚’ã„ã£ãŸã‚“åˆ¥åä¿å­˜ï¼ˆPNG or JPEGï¼‰ã—ç›´ã—ã¦ã‹ã‚‰å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
  }
  if (m.includes("request entity too large") || m.includes("size")) {
    return "ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚è§£åƒåº¦ã‚’ä¸‹ã’ã‚‹ã‹ã€JPEGã§ä¿å­˜ã—ç›´ã—ã¦ãã ã•ã„ã€‚";
  }
  if (m.toLowerCase().includes("api key")) {
    return "APIã‚­ãƒ¼ã®å•é¡ŒãŒå‡ºã¦ã„ã¾ã™ã€‚ã‚µãƒ¼ãƒå´ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
  }
  return m || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚";
}

/** ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®ON/OFF */
function setLoading(on){
  const box = document.getElementById("loading");
  box.style.display = on ? "block" : "none";
}

async function generate(){
  const btn = document.getElementById("btn");
  const prompt = document.getElementById("prompt").value.trim();
  const file = document.getElementById("file").files[0] || null;
  const result = document.getElementById("result");
  const err = document.getElementById("err");

  err.textContent = ""; result.innerHTML = "";

  if (!prompt) {
    err.textContent = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  btn.disabled = true; btn.textContent = "ç”Ÿæˆä¸­â€¦"; setLoading(true);

  try{
    let payload = { prompt };

    // ç”»åƒãŒé¸ã°ã‚Œã¦ã„ãŸã‚‰ï¼šå®‰å…¨ãªPNG(RGBA)ã«ç›´ã—ã¦ã‹ã‚‰é€ã‚‹
    if (file) {
      // æ‹¡å¼µå­ã§ãªãä¸­èº«ã§åˆ¤æ–­ã—ãŸã„ãŒã€ã‚¹ãƒãƒ›ç­‰ã¯ type ãŒç©ºã®ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§å¸å
      const b64png = await fileToPngBase64(file);
      payload.image = {
        name: (file.name || "image.png").replace(/\.[^.]+$/,"") + ".png",
        type: "image/png",
        data: b64png
      };
    }

    const r = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const j = await r.json().catch(()=>({error:"ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™"}));

    if (!r.ok) {
      err.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š " + friendlyError(j.error);
      return;
    }

    if (!j.image) {
      err.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
      return;
    }

    result.innerHTML = `<img src="${j.image}" alt="ç”Ÿæˆç”»åƒ">`;
    // çµæœã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    result.scrollIntoView({behavior:"smooth", block:"start"});

  }catch(e){
    err.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š " + friendlyError(e.message || e);
  }finally{
    btn.disabled = false; btn.textContent = "ç”Ÿæˆ"; setLoading(false);
  }
}

document.getElementById("btn").addEventListener("click", generate);
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
<style>
  :root { --bg:#fafafa; --card:#fff; --text:#222; --muted:#666; --border:#e5e5e5; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans JP",sans-serif; }
  .wrap { max-width:980px; margin:32px auto; padding:0 16px; }
  h1 { font-size:24px; margin:0 0 16px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0; }
  label { font-weight:600; display:block; margin:8px 0 6px; }
  input[type="text"], textarea, select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  textarea { min-height:120px; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .muted { color:var(--muted); font-size:12px; }
  .actions { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
  button { cursor:pointer; padding:10px 16px; border-radius:10px; border:1px solid var(--border); background:#111; color:#fff; font-weight:700; }
  .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .grid img { width:100%; height:auto; border-radius:10px; background:#fff; }
  .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
  .inline { display:flex; gap:10px; align-items:center; }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¨ å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <div class="card">
    <label for="mode">ãƒ¢ãƒ¼ãƒ‰</label>
    <select id="mode">
      <option value="txt2img">ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ–°è¦ä½œæˆï¼ˆtxt2imgï¼‰</option>
      <option value="img2img">å†™çœŸã‚’ãƒ™ãƒ¼ã‚¹ã«ç½®ãæ›ãˆï¼ˆimg2imgï¼‰</option>
      <option value="interrogate">å†™çœŸã‹ã‚‰ã‚¿ã‚°æŠ½å‡ºï¼ˆInterrogateï¼‰</option>
    </select>

    <div id="imageBlock" class="card" style="display:none; margin-top:12px;">
      <label>å†™çœŸã‚’é¸ã¶ï¼ˆimg2img / interrogateï¼‰</label>
      <input id="file" type="file" accept="image/*" />
      <div id="fileInfo" class="muted"></div>
    </div>

    <div class="row">
      <div>
        <label for="preset">ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</label>
        <select id="preset">
          <option value="">ï¼ˆé¸ã°ãªã„ï¼è‡ªç”±æ–‡ã ã‘ï¼‰</option>
          <option value="chibi">â‘  ã‹ã‚ã„ã„ãƒ»ã¡ã³ã‚­ãƒ£ãƒ©é¢¨</option>
          <option value="mature">â‘¡ å¤§äººã£ã½ã„ã‚¢ãƒ‹ãƒ¡èª¿</option>
          <option value="street">â‘¢ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ã‚¹ãƒˆãƒªãƒ¼ãƒˆé¢¨</option>
        </select>
      </div>
      <div class="row3">
        <div>
          <label for="n">æšæ•°</label>
          <select id="n">
            <option>1</option><option selected>6</option><option>4</option><option>8</option>
          </select>
        </div>
        <div>
          <label for="size">ã‚µã‚¤ã‚º</label>
          <select id="size">
            <option>1024x1024</option><option>768x768</option><option>512x512</option>
          </select>
        </div>
        <div>
          <label for="quality">å“è³ª</label>
          <select id="quality">
            <option>low</option><option>high</option>
          </select>
        </div>
      </div>
    </div>

    <label for="prompt">ï¼ˆä»»æ„ï¼‰è‡ªç”±è¿½è¨˜ãƒ†ã‚­ã‚¹ãƒˆ</label>
    <textarea id="prompt" placeholder="ä¾‹ï¼šç¬‘é¡”ã§ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã€ä¸ŠåŠèº«ã€ç™½èƒŒæ™¯ãªã©"></textarea>

    <div class="row">
      <div class="card">
        <label class="inline"><input type="checkbox" id="bgTransparent"> èƒŒæ™¯ã‚’é€éã™ã‚‹</label>
        <label for="bgPreset">èƒŒæ™¯ã‚’å¤‰æ›´ï¼š</label>
        <select id="bgPreset">
          <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰</option>
          <option value="white background">ç™½èƒŒæ™¯</option>
          <option value="pastel gradient with soft clouds">ãƒ‘ã‚¹ãƒ†ãƒ«ï¼‹ãµã‚“ã‚ã‚Šé›²</option>
          <option value="soft blurred realistic urban background">ã‚„ã‚ã‚‰ã‹ã„ãƒªã‚¢ãƒ«é¢¨ã®è¡—ä¸¦ã¿</option>
          <option value="graffiti wall, urban street vibe">ã‚°ãƒ©ãƒ•ã‚£ãƒ†ã‚£å£ã®ã‚¹ãƒˆãƒªãƒ¼ãƒˆ</option>
        </select>
        <label class="inline"><input type="checkbox" id="brightnessUp"> æ˜ã‚‹ã•ã‚’å°‘ã—ä¸Šã’ã‚‹</label>
        <label class="inline"><input type="checkbox" id="moodBoost"> ã¡ã‚‡ã£ã¨é›°å›²æ°—UPï¼ˆ+20%ï¼‰</label>
      </div>
      <div class="card">
        <div class="actions">
          <button id="btnRun">ç”Ÿæˆ</button>
          <button id="btnInterrogate" type="button">å†™çœŸã‹ã‚‰ã‚¿ã‚°æŠ½å‡º</button>
          <span id="status" class="muted"></span>
        </div>
        <p class="muted">â€» txt2img ã¯ã€Œå†™çœŸãªã—ã€ã€‚img2img ã¨ interrogate ã¯ã€Œå†™çœŸå¿…é ˆã€ã€‚</p>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="out" class="grid"></div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
let imageDataUrl = null;

$("#mode").addEventListener("change", ()=>{
  const m = $("#mode").value;
  $("#imageBlock").style.display = (m === "img2img" || m === "interrogate") ? "block" : "none";
});

$("#file").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if (!f) { imageDataUrl = null; $("#fileInfo").textContent = ""; return; }
  const reader = new FileReader();
  reader.onload = ()=>{ imageDataUrl = reader.result; $("#fileInfo").textContent = `${f.name} (${Math.round(f.size/1024)} KB)`; };
  reader.readAsDataURL(f);
});

async function generate() {
  const mode = $("#mode").value;
  const requireImg = (mode === "img2img");
  if (requireImg && !imageDataUrl) { alert("å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  $("#status").textContent = "ç”Ÿæˆä¸­â€¦";
  $("#out").innerHTML = "";

  const payload = {
    prompt: $("#prompt").value.trim(),
    imageDataUrl: (mode === "img2img") ? imageDataUrl : undefined,
    options: {
      preset: $("#preset").value || undefined,
      n: $("#n").value,
      size: $("#size").value,
      quality: $("#quality").value,
      bgTransparent: $("#bgTransparent").checked || undefined,
      bgPreset: $("#bgPreset").value || undefined,
      brightnessUp: $("#brightnessUp").checked || undefined,
      moodBoost: $("#moodBoost").checked || undefined,
    },
  };

  try {
    const r = await fetch("/api/generate", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || ("HTTP "+r.status));

    const images = data.images || [];
    if (!images.length) throw new Error("ç”»åƒãŒè¿”ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    $("#out").innerHTML = images.map(u => `<img src="${u}" alt="result">`).join("");
    $("#status").textContent = `å®Œäº†ï¼ˆ${images.length}æšï¼‰`;
  } catch (e) {
    $("#status").textContent = "å¤±æ•—ï¼š" + (e.message || e);
  }
}

async function interrogate() {
  if (!imageDataUrl) { alert("å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
  $("#status").textContent = "è§£æä¸­â€¦";
  try {
    const r = await fetch("/api/interrogate", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ imageDataUrl }) });
    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || ("HTTP "+r.status));
    const tags = data.tags || "";
    // è§£æçµæœã‚’è¿½è¨˜æ¬„ã¸æŒ¿å…¥
    const t = $("#prompt");
    t.value = (t.value ? t.value + "\n" : "") + tags;
    $("#status").textContent = "ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ";
  } catch (e) {
    $("#status").textContent = "è§£æå¤±æ•—ï¼š" + (e.message || e);
  }
}

$("#btnRun").addEventListener("click", generate);
$("#btnInterrogate").addEventListener("click", interrogate);
</script>
</body>
</html>

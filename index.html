<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>好きなイラストを作ろう</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 20px; background:#fafafa; color:#222; }
    h1 { font-size: 22px; margin-bottom: 16px; }
    .mode-buttons { display:flex; gap:12px; margin-bottom:20px; }
    .mode-buttons button { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .mode-buttons button.active { background:#111; color:#fff; }
    .card { background:#fff; border:1px solid #ccc; border-radius:8px; padding:16px; margin-bottom:16px; }
    label { font-weight:600; display:block; margin:8px 0; }
    textarea, select, input[type="file"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    .actions { display:flex; gap:12px; margin-top:16px; }
    .actions button { flex:1; padding:12px; font-size:16px; border-radius:8px; cursor:pointer; border:none; }
    .btn-main { background:#111; color:#fff; }
    .btn-sub { background:#eee; }
    .muted { color:#666; font-size:13px; margin-top:8px; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .grid img { width:100%; height:auto; border-radius:8px; background:#fff; }
    .small { font-size:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>🎨 好きなイラストを作ろう</h1>

  <!-- 3つの大ボタン（モード） -->
  <div class="mode-buttons">
    <button id="btnFree">① 自由に作る（写真なし）</button>
    <button id="btnImg2Img">② 写真からキャラ化</button>
    <button id="btnInterrogate">③ 写真からタグ抽出</button>
  </div>

  <!-- 写真を選ぶ -->
  <div id="imageBlock" class="card hidden">
    <label>写真を選んでください</label>
    <input type="file" id="fileInput" accept="image/*" />
    <p id="fileInfo" class="muted"></p>
  </div>

  <!-- プリセット（作風） -->
  <div id="presetBlock" class="card hidden">
    <label>作風プリセット（えらばなくてもOK）</label>
    <select id="preset">
      <option value="">選ばない（自由に入力）</option>
      <option value="chibi">① かわいい・ちびキャラ風</option>
      <option value="mature">② 大人っぽいアニメ風</option>
      <option value="street">③ カジュアル・ストリート風</option>
    </select>
  </div>

  <!-- 自由テキスト -->
  <div id="promptBlock" class="card">
    <label id="promptLabel">好きな指示を書いてください（例：笑顔でピースサイン、白背景など）</label>
    <textarea id="prompt" rows="4" placeholder="ここに自由に書いてOK。空でも動きます。"></textarea>
  </div>

  <!-- 補助オプション（共通） -->
  <div id="optionsBlock" class="card">
    <label><input type="checkbox" id="bgTransparent"> 背景を透過する（PNG）</label>
    <label>背景を変える：</label>
    <select id="bgPreset">
      <option value="">（変更しない）</option>
      <option value="white background">白背景</option>
      <option value="simple pastel background">やわらかいパステル背景</option>
      <option value="street background">ストリート風背景</option>
    </select>
    <label><input type="checkbox" id="brightnessUp"> 明るさを少し上げる</label>
    <label><input type="checkbox" id="moodBoost"> 雰囲気をちょっとUP</label>
    <div class="small muted">サイズは 1024×1024 固定（OpenAIの仕様に合わせています）</div>
  </div>

  <!-- 実行ボタン -->
  <div id="actionsBlock" class="card">
    <div class="actions">
      <button class="btn-main" id="btnRun">生成する（3枚固定）</button>
      <button class="btn-sub" id="btnRunInterrogate" class="hidden">写真からタグ抽出</button>
    </div>
    <p class="muted">①自由に作る → 写真不要 ／ ②キャラ化 → 写真が必要 ／ ③タグ抽出 → 写真が必要</p>
    <p id="status" class="muted"></p>
  </div>

  <!-- 出力 -->
  <div class="card">
    <div id="out" class="grid"></div>
  </div>

<script>
  // 便利関数
  const $ = (s)=>document.querySelector(s);
  const show = (el, on)=> el.classList.toggle('hidden', !on);

  // UI要素
  const btnFree = $("#btnFree");
  const btnImg2Img = $("#btnImg2Img");
  const btnInterrogate = $("#btnInterrogate");
  const imageBlock = $("#imageBlock");
  const presetBlock = $("#presetBlock");
  const promptLabel = $("#promptLabel");
  const fileInput = $("#fileInput");
  const fileInfo = $("#fileInfo");
  const btnRun = $("#btnRun");
  const btnRunInterrogate = $("#btnRunInterrogate");
  const statusEl = $("#status");
  const outEl = $("#out");

  // 状態
  let mode = "free";           // free | img2img | interrogate
  let imageDataUrl = null;     // DataURL

  // モード切替
  function setMode(next){
    mode = next;
    [btnFree, btnImg2Img, btnInterrogate].forEach(b=>b.classList.remove("active"));

    if (mode === "free") {
      btnFree.classList.add("active");
      show(imageBlock, false);
      show(presetBlock, false);
      show(btnRunInterrogate, false);
      promptLabel.textContent = "好きな指示を書いてください（例：笑顔でピースサイン、白背景など）";
    } else if (mode === "img2img") {
      btnImg2Img.classList.add("active");
      show(imageBlock, true);
      show(presetBlock, true);
      show(btnRunInterrogate, false);
      promptLabel.textContent = "追加したい指示があれば書いてください（任意）";
    } else { // interrogate
      btnInterrogate.classList.add("active");
      show(imageBlock, true);
      show(presetBlock, false);
      show(btnRunInterrogate, true);
      promptLabel.textContent = "抽出されたタグに追加したい指示があれば書いてください（任意）";
    }
    statusEl.textContent = "";
    outEl.innerHTML = "";
  }

  btnFree.addEventListener("click", ()=>setMode("free"));
  btnImg2Img.addEventListener("click", ()=>setMode("img2img"));
  btnInterrogate.addEventListener("click", ()=>setMode("interrogate"));
  setMode("img2img"); // 起動時の初期モード（好みで free にしてOK）

  // 画像読み込み
  fileInput.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if (!f) { imageDataUrl = null; fileInfo.textContent = ""; return; }
    const reader = new FileReader();
    reader.onload = ()=>{ imageDataUrl = reader.result; fileInfo.textContent = `${f.name}（${Math.round(f.size/1024)} KB）`; };
    reader.readAsDataURL(f);
  });

  // 生成
  btnRun.addEventListener("click", async ()=>{
    statusEl.textContent = "処理中…";
    outEl.innerHTML = "";

    const needPhoto = (mode === "img2img");
    if (needPhoto && !imageDataUrl) { statusEl.textContent = "写真を選んでください。"; return; }

    const payload = {
      prompt: $("#prompt").value.trim(),
      imageDataUrl: (mode === "img2img") ? imageDataUrl : undefined,
      options: {
        preset: $("#preset").value || undefined,
        bgTransparent: $("#bgTransparent").checked || undefined,
        bgPreset: $("#bgPreset").value || undefined,
        brightnessUp: $("#brightnessUp").checked || undefined,
        moodBoost: $("#moodBoost").checked || undefined,
        n: 3   // 3枚固定（レート制限対策）
      }
    };

    try{
      const r = await fetch("/api/generate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const text = await r.text();
        throw new Error(`サーバーの返事が不正（${r.status}）。\n${text.slice(0,120)}`);
      }

      const data = await r.json();
      if (!r.ok) {
        if ((data?.error||"").includes("input-images per min")) {
          throw new Error("同時生成が多すぎます。枚数は5枚以下にしてください。");
        }
        throw new Error(data?.error || `HTTP ${r.status}`);
      }

      const images = data.images || (data.image ? [data.image] : []);
      if (!images.length) throw new Error("画像が返ってきませんでした。");

      outEl.innerHTML = images.map(u=>`<img src="${u}" alt="result">`).join("");
      statusEl.textContent = `完了（${images.length}枚）`;
    }catch(e){
      statusEl.textContent = "失敗：" + (e.message || e);
    }
  });

  // タグ抽出
  btnRunInterrogate.addEventListener("click", async ()=>{
    statusEl.textContent = "写真を解析中…";
    if (!imageDataUrl) { statusEl.textContent = "写真を選んでください。"; return; }

    try{
      const r = await fetch("/api/interrogate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ imageDataUrl })
      });

      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const text = await r.text();
        throw new Error(`APIが見つかりません（${r.status}）。/api/interrogate を確認してください。\n${text.slice(0,120)}`);
      }

      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);

      const tags = data.tags || "";
      const t = $("#prompt");
      t.value = (t.value ? t.value + "\n" : "") + tags;
      statusEl.textContent = "タグをテキスト欄に追加しました。";
    }catch(e){
      statusEl.textContent = "解析失敗：" + (e.message || e);
    }
  });
</script>
</body>
</html>

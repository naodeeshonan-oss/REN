<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>好きなイラストを作ろう</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#222;--muted:#666;--border:#e5e5e5}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans JP",sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{display:flex;gap:.6rem;align-items:center;font-size:24px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px}
    textarea{min-height:120px}
    button{cursor:pointer;padding:12px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-size:15px}
    button[disabled]{opacity:.45;cursor:wait}
    .actions{display:flex;gap:8px;align-items:center;margin-top:16px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12.5px;line-height:1.6}
    .out{display:grid;place-items:center;min-height:260px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
    .img{max-width:100%;height:auto;border-radius:12px;display:block}
    .small{font-size:12px}
    .ok{color:#0a7a20}
    .err{color:#b10000}
    .help{font-size:13px;color:#555}
    @media(min-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🎨 好きなイラストを作ろう</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>作風プリセット（必須）</label>
          <select id="style">
            <option value="chibi">① かわいい・ちびキャラ風</option>
            <option value="mature">② 大人っぽいアニメ調</option>
            <option value="street">③ カジュアル／ポップ・ストリート風</option>
          </select>

          <label class="mt">（任意）自由追記テキスト</label>
          <textarea id="extra" placeholder="例：笑顔でピースサイン、上半身、白背景 など"></textarea>

          <div class="actions">
            <button id="gen">生成する（1枚固定）</button>
            <span id="stat" class="help"></span>
          </div>

          <p class="muted">
            写真は<strong>1枚だけ選択</strong>してください（そっくり優先）。<br>
            アップした写真は自動で <strong>最大辺 1024px / 400KB 目標</strong> に圧縮されます（413対策）。
          </p>
        </div>

        <div>
          <label>写真を選んでください（推奨：顔が大きく明るい1枚）</label>
          <input type="file" id="file" accept="image/*" />
          <p class="small muted">※「自由に作る（テキストのみ）」用途は未対応。必ず顔写真1枚を選んでください。</p>

          <div class="card" style="margin:12px 0 0">
            <label>補助チェック（任意）</label>
            <div class="small">
              <label><input type="checkbox" id="bright"> 明るさを少し上げる</label><br/>
              <label><input type="checkbox" id="mood"> ちょっと雰囲気UP（+20%）</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>出力</label>
      <div id="out" class="out small muted">ここに結果が表示されます</div>
    </div>

    <div class="card">
      <div class="muted">
        <strong>使い方の超要約</strong>：①スタイル選択 → ②写真1枚選択 → ③必要なら追記 → ④「生成する」。<br>
        すべて <strong>1枚生成・そっくり優先・ネガティブプロンプト必須</strong> で動作します。
      </div>
    </div>
  </div>

<script>
const el = (id)=>document.getElementById(id);
const out = el('out');
const stat = el('stat');

function msg(text, cls='help'){ stat.className=cls; stat.textContent=text; }
function showError(e){ out.innerHTML = '<span class="err">❌ '+ e +'</span>'; }

/* 画像を “最大辺1024px / ~400KB” までクライアント側で圧縮 */
async function compressImage(file, maxSide=1024, targetKb=400){
  const img = await new Promise((res,rej)=>{
    const i = new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src = URL.createObjectURL(file);
  });

  const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  // 品質を下げながら 400KB を目標に調整
  let q = 0.92, dataUrl;
  for(let t=0;t<8;t++){
    dataUrl = canvas.toDataURL('image/jpeg', q);
    const kb = Math.ceil((dataUrl.length*3/4)/1024);
    if(kb<=targetKb) break;
    q -= 0.12; // 徐々に縮める
    if(q<0.45) break;
  }
  return dataUrl;
}

function buildOptions(){
  return {
    style: el('style').value,
    extra: el('extra').value || "",
    brightnessUp: el('bright').checked,
    moodBoost: el('mood').checked
  };
}

async function generate(){
  try{
    const f = el('file').files[0];
    if(!f){ showError('写真を1枚選んでください'); return; }

    msg('写真を圧縮中…');
    const imageDataUrl = await compressImage(f);

    msg('生成中…（30～60秒のことがあります）', 'help');

    const r = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        imageDataUrl,
        options: buildOptions()
      })
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j?.error || 'サーバエラー');

    out.innerHTML = '';
    const img = new Image();
    img.src = j.image;
    img.className = 'img';
    out.appendChild(img);
    msg('完了（1枚生成）', 'ok');
  }catch(e){
    showError(String(e.message||e));
    msg('');
  }
}

el('gen').addEventListener('click', ()=>{
  out.innerHTML = '<span class="help">…生成を開始しました</span>';
  el('gen').disabled = true;
  generate().finally(()=> el('gen').disabled = false);
});
</script>
</body>
</html>

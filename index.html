<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#222;--muted:#666;--border:#e5e5e5}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans JP",sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{display:flex;gap:.6rem;align-items:center;font-size:24px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px}
    textarea{min-height:120px}
    button{cursor:pointer;padding:12px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-size:15px}
    button[disabled]{opacity:.45;cursor:wait}
    .actions{display:flex;gap:8px;align-items:center;margin-top:16px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12.5px;line-height:1.6}
    .out{display:grid;place-items:center;min-height:260px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
    .img{max-width:100%;height:auto;border-radius:12px;display:block}
    .small{font-size:12px}
    .ok{color:#0a7a20}
    .err{color:#b10000}
    .help{font-size:13px;color:#555}
    @media(min-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¨ å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆå¿…é ˆï¼‰</label>
          <select id="style">
            <option value="chibi">â‘  ã‹ã‚ã„ã„ãƒ»ã¡ã³ã‚­ãƒ£ãƒ©é¢¨</option>
            <option value="mature">â‘¡ å¤§äººã£ã½ã„ã‚¢ãƒ‹ãƒ¡èª¿</option>
            <option value="street">â‘¢ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ãƒãƒƒãƒ—ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆé¢¨</option>
          </select>

          <label class="mt">ï¼ˆä»»æ„ï¼‰è‡ªç”±è¿½è¨˜ãƒ†ã‚­ã‚¹ãƒˆ</label>
          <textarea id="extra" placeholder="ä¾‹ï¼šç¬‘é¡”ã§ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã€ä¸ŠåŠèº«ã€ç™½èƒŒæ™¯ ãªã©"></textarea>

          <div class="actions">
            <button id="gen">ç”Ÿæˆã™ã‚‹ï¼ˆ1æšå›ºå®šï¼‰</button>
            <span id="stat" class="help"></span>
          </div>

          <p class="muted">
            å†™çœŸã¯<strong>1æšã ã‘é¸æŠ</strong>ã—ã¦ãã ã•ã„ï¼ˆãã£ãã‚Šå„ªå…ˆï¼‰ã€‚<br>
            ã‚¢ãƒƒãƒ—ã—ãŸå†™çœŸã¯è‡ªå‹•ã§ <strong>æœ€å¤§è¾º 1024px / 400KB ç›®æ¨™</strong> ã«åœ§ç¸®ã•ã‚Œã¾ã™ï¼ˆ413å¯¾ç­–ï¼‰ã€‚
          </p>
        </div>

        <div>
          <label>å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæ¨å¥¨ï¼šé¡”ãŒå¤§ããæ˜ã‚‹ã„1æšï¼‰</label>
          <input type="file" id="file" accept="image/*" />
          <p class="small muted">â€»ã€Œè‡ªç”±ã«ä½œã‚‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ã€ç”¨é€”ã¯æœªå¯¾å¿œã€‚å¿…ãšé¡”å†™çœŸ1æšã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>

          <div class="card" style="margin:12px 0 0">
            <label>è£œåŠ©ãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰</label>
            <div class="small">
              <label><input type="checkbox" id="bright"> æ˜ã‚‹ã•ã‚’å°‘ã—ä¸Šã’ã‚‹</label><br/>
              <label><input type="checkbox" id="mood"> ã¡ã‚‡ã£ã¨é›°å›²æ°—UPï¼ˆ+20%ï¼‰</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>å‡ºåŠ›</label>
      <div id="out" class="out small muted">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <div class="card">
      <div class="muted">
        <strong>ä½¿ã„æ–¹ã®è¶…è¦ç´„</strong>ï¼šâ‘ ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ â†’ â‘¡å†™çœŸ1æšé¸æŠ â†’ â‘¢å¿…è¦ãªã‚‰è¿½è¨˜ â†’ â‘£ã€Œç”Ÿæˆã™ã‚‹ã€ã€‚<br>
        ã™ã¹ã¦ <strong>1æšç”Ÿæˆãƒ»ãã£ãã‚Šå„ªå…ˆãƒ»ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¿…é ˆ</strong> ã§å‹•ä½œã—ã¾ã™ã€‚
      </div>
    </div>
  </div>

<script>
const el = (id)=>document.getElementById(id);
const out = el('out');
const stat = el('stat');

function msg(text, cls='help'){ stat.className=cls; stat.textContent=text; }
function showError(e){ out.innerHTML = '<span class="err">âŒ '+ e +'</span>'; }

/* ç”»åƒã‚’ â€œæœ€å¤§è¾º1024px / ~400KBâ€ ã¾ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§åœ§ç¸® */
async function compressImage(file, maxSide=1024, targetKb=400){
  const img = await new Promise((res,rej)=>{
    const i = new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src = URL.createObjectURL(file);
  });

  const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  // å“è³ªã‚’ä¸‹ã’ãªãŒã‚‰ 400KB ã‚’ç›®æ¨™ã«èª¿æ•´
  let q = 0.92, dataUrl;
  for(let t=0;t<8;t++){
    dataUrl = canvas.toDataURL('image/jpeg', q);
    const kb = Math.ceil((dataUrl.length*3/4)/1024);
    if(kb<=targetKb) break;
    q -= 0.12; // å¾ã€…ã«ç¸®ã‚ã‚‹
    if(q<0.45) break;
  }
  return dataUrl;
}

function buildOptions(){
  return {
    style: el('style').value,
    extra: el('extra').value || "",
    brightnessUp: el('bright').checked,
    moodBoost: el('mood').checked
  };
}

async function generate(){
  try{
    const f = el('file').files[0];
    if(!f){ showError('å†™çœŸã‚’1æšé¸ã‚“ã§ãã ã•ã„'); return; }

    msg('å†™çœŸã‚’åœ§ç¸®ä¸­â€¦');
    const imageDataUrl = await compressImage(f);

    msg('ç”Ÿæˆä¸­â€¦ï¼ˆ30ï½60ç§’ã®ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰', 'help');

    const r = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        imageDataUrl,
        options: buildOptions()
      })
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(j?.error || 'ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼');

    out.innerHTML = '';
    const img = new Image();
    img.src = j.image;
    img.className = 'img';
    out.appendChild(img);
    msg('å®Œäº†ï¼ˆ1æšç”Ÿæˆï¼‰', 'ok');
  }catch(e){
    showError(String(e.message||e));
    msg('');
  }
}

el('gen').addEventListener('click', ()=>{
  out.innerHTML = '<span class="help">â€¦ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ</span>';
  el('gen').disabled = true;
  generate().finally(()=> el('gen').disabled = false);
});
</script>
</body>
</html>

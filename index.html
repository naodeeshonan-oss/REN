<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>好きなイラストを作ろう</title>
  <style>
    :root{--w:820px}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; line-height:1.6; margin:0; background:#fff;}
    main{max-width:var(--w); margin:2rem auto; padding:0 1rem;}
    h1{display:flex; gap:.6rem; align-items:center; font-size:clamp(20px,4vw,32px); margin:.2rem 0 1rem}
    h1:before{content:"🎨"}
    .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    input[type=text]{flex:1; min-width:260px; padding:.6rem .7rem; font-size:1rem}
    button{padding:.55rem .9rem; font-size:1rem; cursor:pointer}
    .opts{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:.35rem .9rem; margin:.6rem 0 1rem}
    .note{background:#f7f7f7; border:1px solid #e5e5e5; padding:.8rem; border-radius:.4rem; font-size:.95rem}
    #result img{max-width:100%; display:block; margin:1rem 0; border:1px solid #ddd}
    .err{color:#c00; margin-top:.6rem}
    .pill{display:inline-flex; gap:.35rem; align-items:center; border:1px solid #ddd; padding:.35rem .55rem; border-radius:999px; background:#fff}
    input[type=file]{display:none}
    label[for=up]{cursor:pointer}
    .spinner{display:inline-block; width:20px; height:20px; border-radius:50%; border:3px solid #ddd; border-top-color:#333; animation:spin 1s linear infinite; vertical-align:-5px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{font-size:.92rem; color:#555}
  </style>
</head>
<body>
<main>
  <h1>好きなイラストを作ろう</h1>

  <div class="row" style="gap:.5rem  .5rem;">
    <input id="prompt" type="text" placeholder="例：富士山に登る猫／人物写真は“笑顔で似せて” など">
    <button id="go">生成</button>
  </div>

  <div class="row" style="margin:.35rem 0 0;">
    <div class="pill">
      <label for="preset">作風プリセット（任意）</label>
      <select id="preset">
        <option value="">— なし —</option>
        <option value="anime-soft">やさしいアニメ調</option>
        <option value="pixar-soft">ピクサー風（控えめ）</option>
        <option value="ghibli-soft">ジブリ風（控えめ）</option>
        <option value="watercolor">水彩タッチ</option>
      </select>
    </div>

    <div class="pill">
      <label for="up">ファイルを選択</label>
      <input id="up" type="file" accept="image/*">
      <span id="fname" class="hint">選択されていません</span>
    </div>
  </div>

  <div class="opts">
    <label><input id="lite"  type="checkbox"> ちょい盛り（+20%だけ雰囲気よく）</label>
    <label><input id="smile" type="checkbox"> 自然な笑顔にする</label>
    <label><input id="clean" type="checkbox" checked> 肌・髪をきれいに整える（やりすぎない）</label>
    <label><input id="lockFace" type="checkbox" checked> 本人の特徴は強く残す（別人化させない）</label>
  </div>

  <div class="note">
    <b>画像アップロードの注意</b><br>
    使える形式：JPEG / PNG / WebP（<u>PNG は保存の仕方によって失敗することがあります</u>）<br>
    失敗例：<code>unsupported mimetype: application/octet-stream</code>（拡張子が PNG でも中身が異常）／
    <code>format must be RGBA</code>（透明情報なし PNG）<br>
    解決法：一度スマホ/PCの編集機能で開いて「<b>別名で保存 → PNG もしくは JPEG</b>」にし直すと直ることが多いです。
  </div>

  <div id="result"></div>
  <div id="err" class="err"></div>
</main>

<script>
const $ = id => document.getElementById(id);
const btn = $("go"), file = $("up"), fname = $("fname"), result = $("result"), err = $("err");

file.addEventListener("change", () => {
  fname.textContent = file.files?.[0]?.name || "選択されていません";
});

async function fileToBase64(f){
  if(!f) return null;
  const buf = await f.arrayBuffer();
  // ここで base64 文字列へ
  let binary = "";
  const bytes = new Uint8Array(buf);
  const len = bytes.byteLength;
  for (let i=0; i<len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary); // dataURL は付けず、中身だけを送る
}

btn.addEventListener("click", async () => {
  err.textContent = "";
  result.innerHTML = "";

  const prompt = $("prompt").value.trim();
  if(!prompt){ err.textContent = "プロンプトを入力してください。"; return; }

  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> 生成中…';

  try{
    const img = file.files?.[0] ? {
      mime: file.files[0].type || "image/jpeg",
      name: file.files[0].name || "upload.jpg",
      b64: await fileToBase64(file.files[0])
    } : null;

    const body = {
      prompt,
      options:{
        preset: $("preset").value,
        lite: $("lite").checked,
        smile: $("smile").checked,
        clean: $("clean").checked,
        lockFace: $("lockFace").checked
      },
      image: img
    };

    const r = await fetch("/api/generate",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const j = await r.json().catch(()=> ({}));
    if(!r.ok){
      err.textContent = "エラー: " + (j.error || "不明なエラー");
      return;
    }
    result.innerHTML = `<img alt="生成画像" src="${j.image}">`;
  }catch(e){
    err.textContent = "通信エラー: " + e.message;
  }finally{
    btn.disabled = false; btn.textContent = "生成";
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 20px; background:#fafafa; color:#222; }
    h1 { font-size: 22px; margin-bottom: 16px; }
    .mode-buttons { display:flex; gap:12px; margin-bottom:20px; }
    .mode-buttons button { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .mode-buttons button.active { background:#111; color:#fff; }
    .card { background:#fff; border:1px solid #ccc; border-radius:8px; padding:16px; margin-bottom:16px; }
    label { font-weight:600; display:block; margin:8px 0; }
    textarea, select, input[type="file"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    .actions { display:flex; gap:12px; margin-top:16px; }
    .actions button { flex:1; padding:12px; font-size:16px; border-radius:8px; cursor:pointer; border:none; }
    .btn-main { background:#111; color:#fff; }
    .btn-sub { background:#eee; }
    .muted { color:#666; font-size:13px; margin-top:8px; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .grid img { width:100%; height:auto; border-radius:8px; background:#fff; }
    .small { font-size:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>ğŸ¨ å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <!-- 3ã¤ã®å¤§ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
  <div class="mode-buttons">
    <button id="btnFree">â‘  è‡ªç”±ã«ä½œã‚‹ï¼ˆå†™çœŸãªã—ï¼‰</button>
    <button id="btnImg2Img">â‘¡ å†™çœŸã‹ã‚‰ã‚­ãƒ£ãƒ©åŒ–</button>
    <button id="btnInterrogate">â‘¢ å†™çœŸã‹ã‚‰ã‚¿ã‚°æŠ½å‡º</button>
  </div>

  <!-- å†™çœŸã‚’é¸ã¶ -->
  <div id="imageBlock" class="card hidden">
    <label>å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„</label>
    <input type="file" id="fileInput" accept="image/*" />
    <p id="fileInfo" class="muted"></p>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä½œé¢¨ï¼‰ -->
  <div id="presetBlock" class="card hidden">
    <label>ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãˆã‚‰ã°ãªãã¦ã‚‚OKï¼‰</label>
    <select id="preset">
      <option value="">é¸ã°ãªã„ï¼ˆè‡ªç”±ã«å…¥åŠ›ï¼‰</option>
      <option value="chibi">â‘  ã‹ã‚ã„ã„ãƒ»ã¡ã³ã‚­ãƒ£ãƒ©é¢¨</option>
      <option value="mature">â‘¡ å¤§äººã£ã½ã„ã‚¢ãƒ‹ãƒ¡é¢¨</option>
      <option value="street">â‘¢ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆé¢¨</option>
    </select>
  </div>

  <!-- è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆ -->
  <div id="promptBlock" class="card">
    <label id="promptLabel">å¥½ããªæŒ‡ç¤ºã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç¬‘é¡”ã§ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã€ç™½èƒŒæ™¯ãªã©ï¼‰</label>
    <textarea id="prompt" rows="4" placeholder="ã“ã“ã«è‡ªç”±ã«æ›¸ã„ã¦OKã€‚ç©ºã§ã‚‚å‹•ãã¾ã™ã€‚"></textarea>
  </div>

  <!-- è£œåŠ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå…±é€šï¼‰ -->
  <div id="optionsBlock" class="card">
    <label><input type="checkbox" id="bgTransparent"> èƒŒæ™¯ã‚’é€éã™ã‚‹ï¼ˆPNGï¼‰</label>
    <label>èƒŒæ™¯ã‚’å¤‰ãˆã‚‹ï¼š</label>
    <select id="bgPreset">
      <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰</option>
      <option value="white background">ç™½èƒŒæ™¯</option>
      <option value="simple pastel background">ã‚„ã‚ã‚‰ã‹ã„ãƒ‘ã‚¹ãƒ†ãƒ«èƒŒæ™¯</option>
      <option value="street background">ã‚¹ãƒˆãƒªãƒ¼ãƒˆé¢¨èƒŒæ™¯</option>
    </select>
    <label><input type="checkbox" id="brightnessUp"> æ˜ã‚‹ã•ã‚’å°‘ã—ä¸Šã’ã‚‹</label>
    <label><input type="checkbox" id="moodBoost"> é›°å›²æ°—ã‚’ã¡ã‚‡ã£ã¨UP</label>
    <div class="small muted">ã‚µã‚¤ã‚ºã¯ 1024Ã—1024 å›ºå®šï¼ˆOpenAIã®ä»•æ§˜ã«åˆã‚ã›ã¦ã„ã¾ã™ï¼‰</div>
  </div>

  <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
  <div id="actionsBlock" class="card">
    <div class="actions">
      <button class="btn-main" id="btnRun">ç”Ÿæˆã™ã‚‹ï¼ˆ3æšå›ºå®šï¼‰</button>
      <button class="btn-sub" id="btnRunInterrogate" class="hidden">å†™çœŸã‹ã‚‰ã‚¿ã‚°æŠ½å‡º</button>
    </div>
    <p class="muted">â‘ è‡ªç”±ã«ä½œã‚‹ â†’ å†™çœŸä¸è¦ ï¼ â‘¡ã‚­ãƒ£ãƒ©åŒ– â†’ å†™çœŸãŒå¿…è¦ ï¼ â‘¢ã‚¿ã‚°æŠ½å‡º â†’ å†™çœŸãŒå¿…è¦</p>
    <p id="status" class="muted"></p>
  </div>

  <!-- å‡ºåŠ› -->
  <div class="card">
    <div id="out" class="grid"></div>
  </div>

<script>
  // ä¾¿åˆ©é–¢æ•°
  const $ = (s)=>document.querySelector(s);
  const show = (el, on)=> el.classList.toggle('hidden', !on);

  // UIè¦ç´ 
  const btnFree = $("#btnFree");
  const btnImg2Img = $("#btnImg2Img");
  const btnInterrogate = $("#btnInterrogate");
  const imageBlock = $("#imageBlock");
  const presetBlock = $("#presetBlock");
  const promptLabel = $("#promptLabel");
  const fileInput = $("#fileInput");
  const fileInfo = $("#fileInfo");
  const btnRun = $("#btnRun");
  const btnRunInterrogate = $("#btnRunInterrogate");
  const statusEl = $("#status");
  const outEl = $("#out");

  // çŠ¶æ…‹
  let mode = "free";           // free | img2img | interrogate
  let imageDataUrl = null;     // DataURL

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  function setMode(next){
    mode = next;
    [btnFree, btnImg2Img, btnInterrogate].forEach(b=>b.classList.remove("active"));

    if (mode === "free") {
      btnFree.classList.add("active");
      show(imageBlock, false);
      show(presetBlock, false);
      show(btnRunInterrogate, false);
      promptLabel.textContent = "å¥½ããªæŒ‡ç¤ºã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç¬‘é¡”ã§ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã€ç™½èƒŒæ™¯ãªã©ï¼‰";
    } else if (mode === "img2img") {
      btnImg2Img.classList.add("active");
      show(imageBlock, true);
      show(presetBlock, true);
      show(btnRunInterrogate, false);
      promptLabel.textContent = "è¿½åŠ ã—ãŸã„æŒ‡ç¤ºãŒã‚ã‚Œã°æ›¸ã„ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰";
    } else { // interrogate
      btnInterrogate.classList.add("active");
      show(imageBlock, true);
      show(presetBlock, false);
      show(btnRunInterrogate, true);
      promptLabel.textContent = "æŠ½å‡ºã•ã‚ŒãŸã‚¿ã‚°ã«è¿½åŠ ã—ãŸã„æŒ‡ç¤ºãŒã‚ã‚Œã°æ›¸ã„ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰";
    }
    statusEl.textContent = "";
    outEl.innerHTML = "";
  }

  btnFree.addEventListener("click", ()=>setMode("free"));
  btnImg2Img.addEventListener("click", ()=>setMode("img2img"));
  btnInterrogate.addEventListener("click", ()=>setMode("interrogate"));
  setMode("img2img"); // èµ·å‹•æ™‚ã®åˆæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆå¥½ã¿ã§ free ã«ã—ã¦OKï¼‰

  // ç”»åƒèª­ã¿è¾¼ã¿
  fileInput.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if (!f) { imageDataUrl = null; fileInfo.textContent = ""; return; }
    const reader = new FileReader();
    reader.onload = ()=>{ imageDataUrl = reader.result; fileInfo.textContent = `${f.name}ï¼ˆ${Math.round(f.size/1024)} KBï¼‰`; };
    reader.readAsDataURL(f);
  });

  // ç”Ÿæˆ
  btnRun.addEventListener("click", async ()=>{
    statusEl.textContent = "å‡¦ç†ä¸­â€¦";
    outEl.innerHTML = "";

    const needPhoto = (mode === "img2img");
    if (needPhoto && !imageDataUrl) { statusEl.textContent = "å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"; return; }

    const payload = {
      prompt: $("#prompt").value.trim(),
      imageDataUrl: (mode === "img2img") ? imageDataUrl : undefined,
      options: {
        preset: $("#preset").value || undefined,
        bgTransparent: $("#bgTransparent").checked || undefined,
        bgPreset: $("#bgPreset").value || undefined,
        brightnessUp: $("#brightnessUp").checked || undefined,
        moodBoost: $("#moodBoost").checked || undefined,
        n: 3   // 3æšå›ºå®šï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
      }
    };

    try{
      const r = await fetch("/api/generate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const text = await r.text();
        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã®è¿”äº‹ãŒä¸æ­£ï¼ˆ${r.status}ï¼‰ã€‚\n${text.slice(0,120)}`);
      }

      const data = await r.json();
      if (!r.ok) {
        if ((data?.error||"").includes("input-images per min")) {
          throw new Error("åŒæ™‚ç”ŸæˆãŒå¤šã™ãã¾ã™ã€‚æšæ•°ã¯5æšä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚");
        }
        throw new Error(data?.error || `HTTP ${r.status}`);
      }

      const images = data.images || (data.image ? [data.image] : []);
      if (!images.length) throw new Error("ç”»åƒãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚");

      outEl.innerHTML = images.map(u=>`<img src="${u}" alt="result">`).join("");
      statusEl.textContent = `å®Œäº†ï¼ˆ${images.length}æšï¼‰`;
    }catch(e){
      statusEl.textContent = "å¤±æ•—ï¼š" + (e.message || e);
    }
  });

  // ã‚¿ã‚°æŠ½å‡º
  btnRunInterrogate.addEventListener("click", async ()=>{
    statusEl.textContent = "å†™çœŸã‚’è§£æä¸­â€¦";
    if (!imageDataUrl) { statusEl.textContent = "å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"; return; }

    try{
      const r = await fetch("/api/interrogate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ imageDataUrl })
      });

      const ct = r.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const text = await r.text();
        throw new Error(`APIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${r.status}ï¼‰ã€‚/api/interrogate ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${text.slice(0,120)}`);
      }

      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);

      const tags = data.tags || "";
      const t = $("#prompt");
      t.value = (t.value ? t.value + "\n" : "") + tags;
      statusEl.textContent = "ã‚¿ã‚°ã‚’ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã«è¿½åŠ ã—ã¾ã—ãŸã€‚";
    }catch(e){
      statusEl.textContent = "è§£æå¤±æ•—ï¼š" + (e.message || e);
    }
  });
</script>
</body>
</html>

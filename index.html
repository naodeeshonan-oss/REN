<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    :root { --fg:#222; --muted:#666; }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,Meiryo,sans-serif;
         color:var(--fg); max-width:820px; margin:2rem auto; padding:1rem;}
    h1{display:flex; gap:.5rem; align-items:center; font-size:clamp(1.4rem,3vw,2rem);}
    h1::before{content:"ğŸ¨";}
    .row{display:flex; gap:.5rem; align-items:center}
    input[type="text"]{flex:1; padding:.7rem .8rem; font-size:1rem; border:1px solid #ccc; border-radius:.5rem;}
    input[type="file"], select, label{font-size:.95rem;}
    button{padding:.65rem .9rem; font-size:1rem; border:1px solid #ccc; border-radius:.5rem; background:#fff; cursor:pointer;}
    button[disabled]{opacity:.6; cursor:default;}
    .note{margin:1rem 0; font-size:.92rem; color:var(--muted); background:#f7f7f7; border:1px solid #eee; border-radius:.6rem; padding:.8rem 1rem; line-height:1.7;}
    .error{color:#b00020; margin:.6rem 0;}
    img.gen{max-width:100%; margin-top:1rem; border:1px solid #ddd; border-radius:.5rem}

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆå¹²æ”¯ãŒå³ã¸æ­©ãï¼‰ */
    .loading {display:none; align-items:center; gap:.6rem; margin:.6rem 0 0; color:#555; font-size:.95rem;}
    .walklane { position:relative; width:120px; height:28px; overflow:hidden; border:1px solid #eee; border-radius:999px; background:#fafafa;}
    .animal { position:absolute; top:50%; transform:translate(-100%, -50%); font-size:22px; line-height:1; animation: walk 1.6s linear infinite;}
    @keyframes walk { 0%{ transform:translate(-100%, -50%);} 100%{ transform:translate(120px, -50%);} }
    .grid{display:grid; grid-template-columns: 1fr; gap:.6rem;}
    @media(min-width:720px){ .grid{grid-template-columns: 1fr 1fr;} }
    .optbox{background:#fafafa; border:1px solid #eee; border-radius:.6rem; padding:.6rem .8rem;}
  </style>
</head>
<body>
  <h1>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <!-- ä¸Šæ®µï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ç”Ÿæˆãƒœã‚¿ãƒ³ -->
  <div class="row" style="margin:.6rem 0 0">
    <input id="prompt" type="text" placeholder="ä¾‹: å¯Œå£«å±±ã«ç™»ã‚‹çŒ« / ã“ã®å†™çœŸã‚’ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼é¢¨ã« ãªã©" />
    <button id="btn">ç”Ÿæˆ</button>
  </div>

  <!-- ç”»åƒé¸æŠ -->
  <div style="margin:.6rem 0 .2rem">
    <input id="file" type="file" accept="image/*">
  </div>

  <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ™ãƒ¼ã‚¹ã¯ä½•ã‚‚ã—ãªã„ã€‚é¸ã°ã‚ŒãŸæ™‚ã ã‘è¶³ã™ï¼‰ -->
  <div class="grid" style="margin:.6rem 0">
    <div class="optbox">
      <div style="margin-bottom:.4rem"><b>ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</b></div>
      <select id="preset" style="width:100%">
        <option value="">ï¼ˆé¸ã°ãªã„ï¼ãƒ™ãƒ¼ã‚¹ã®ã¾ã¾ï¼‰</option>
        <option value="watercolor">æ°´å½©ç”»é¢¨</option>
        <option value="disney">ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼é¢¨</option>
        <option value="ghibli">ã‚¸ãƒ–ãƒªé¢¨</option>
        <option value="anime">ã‚¢ãƒ‹ãƒ¡èª¿ï¼ˆç·šç”»ã£ã½ã„ï¼‰</option>
        <option value="simple">ã‚·ãƒ³ãƒ—ãƒ«ã‚­ãƒ£ãƒ©é¢¨</option>
      </select>
    </div>

    <div class="optbox">
      <div style="margin-bottom:.4rem"><b>è£œåŠ©ãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰</b></div>
      <div><label><input type="checkbox" id="bgTransparent"> èƒŒæ™¯ã‚’é€éã™ã‚‹</label></div>
      <div style="display:flex; gap:.4rem; align-items:center; margin-top:.4rem">
        <span style="white-space:nowrap">èƒŒæ™¯ã‚’å¤‰æ›´ï¼š</span>
        <select id="bgPreset" style="flex:1">
          <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰</option>
          <option>cherry blossoms</option>
          <option>beach</option>
          <option>blue sky</option>
          <option>night city</option>
          <option>school classroom</option>
          <option>park in spring</option>
        </select>
      </div>
      <div style="margin-top:.4rem"><label><input type="checkbox" id="brightnessUp"> æ˜ã‚‹ã•ã‚’å°‘ã—ä¸Šã’ã‚‹</label></div>
      <div style="margin-top:.2rem"><label><input type="checkbox" id="moodBoost"> ã¡ã‚‡ã£ã¨é›°å›²æ°—UPï¼ˆ+20%ï¼‰</label></div>
    </div>
  </div>

  <!-- æ³¨æ„æ›¸ãï¼ˆç°¡ç•¥ç‰ˆï¼š2ã€œ3è¡Œï¼‰ -->
  <div class="note">
    ç”»åƒã‚’é¸ã¶ã¨ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ã€ç”»åƒãªã—ã¯ã€Œæ–°è¦ä½œæˆã€ã§ã™ã€‚<br>
    ä½¿ãˆã‚‹å½¢å¼ï¼šJPEG / PNG / WebPã€‚ç·¨é›†æ™‚ã¯å†…éƒ¨ã§ PNG(RGBA) ã«å¤‰æ›ã—ã¾ã™ã€‚<br>
    å¤±æ•—ã™ã‚‹æ™‚ã¯ç«¯æœ«ã®ç·¨é›†æ©Ÿèƒ½ã§ã€Œåˆ¥åã§ä¿å­˜ â†’ PNG ã¾ãŸã¯ JPEGã€ã«ç›´ã™ã¨æ”¹å–„ã—ã¾ã™ã€‚
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼šå¹²æ”¯ãŒæ­©ã -->
  <div class="loading" id="loading">
    <div class="walklane"><div class="animal" id="animal">ğŸ­</div></div>
    <span>ç”Ÿæˆä¸­â€¦ï¼ˆå°‘ã—ãŠå¾…ã¡ãã ã•ã„ï¼‰</span>
  </div>

  <div id="err" class="error"></div>
  <div id="result"></div>

<script>
/* å¹²æ”¯ï¼ˆå³ã¸æ­©ãï¼‰ */
const zodiac = ["ğŸ­","ğŸ®","ğŸ¯","ğŸ°","ğŸ²","ğŸ","ğŸ´","ğŸ‘","ğŸµ","ğŸ”","ğŸ¶","ğŸ—"];
let zi = 0, zTimer=null;
function startLoading(){
  const box = document.getElementById("loading");
  const a = document.getElementById("animal");
  box.style.display = "flex";
  a.style.animation = "none"; a.offsetHeight; a.style.animation = null;
  a.textContent = zodiac[zi % zodiac.length];
  zTimer = setInterval(()=>{
    zi++; a.textContent = zodiac[zi % zodiac.length];
    a.style.animation = "none"; a.offsetHeight; a.style.animation = null;
  }, 900);
}
function stopLoading(){
  const box = document.getElementById("loading");
  box.style.display = "none";
  if (zTimer){ clearInterval(zTimer); zTimer=null; }
}

/* ç”»åƒã‚’ PNG(RGBA) ã«å¤‰æ›ï¼†é•·è¾º1200pxã¸ç¸®å°ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ */
async function toPngRgbaDataURL(file){
  const ok = ["image/jpeg","image/png","image/webp"];
  if (!ok.includes(file.type || "")) throw new Error("ã“ã®ç”»åƒå½¢å¼ã¯æ‰±ãˆã¾ã›ã‚“ã€‚JPEG/PNG/WebP ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
  const url = URL.createObjectURL(file);
  const img = await new Promise((res,rej)=>{
    const im = new Image();
    im.onload = ()=>{ URL.revokeObjectURL(url); res(im); };
    im.onerror = ()=>{ URL.revokeObjectURL(url); rej(new Error("ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ")); };
    im.crossOrigin = "";
    im.src = url;
  });
  const maxSide = 1200;
  let {width:w, height:h} = img;
  const scale = Math.min(1, maxSide / Math.max(w,h));
  const cw = Math.round(w * scale), ch = Math.round(h * scale);
  const cv = document.createElement("canvas");
  cv.width = cw; cv.height = ch;
  const ctx = cv.getContext("2d");
  ctx.drawImage(img, 0, 0, cw, ch);
  return cv.toDataURL("image/png");
}

/* ç”Ÿæˆ */
document.getElementById("btn").addEventListener("click", generate);
async function generate(){
  const btn = document.getElementById("btn");
  const prompt = document.getElementById("prompt").value.trim();
  const file = document.getElementById("file").files[0];

  const options = {
    preset: document.getElementById("preset").value || "",
    bgTransparent: document.getElementById("bgTransparent").checked || false,
    bgPreset: document.getElementById("bgPreset").value || "",
    brightnessUp: document.getElementById("brightnessUp").checked || false,
    moodBoost: document.getElementById("moodBoost").checked || false,
  };

  const err = document.getElementById("err");
  const result = document.getElementById("result");
  err.textContent = ""; result.innerHTML = "";

  if(!prompt){ err.textContent = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

  btn.disabled = true; btn.textContent = "ç”Ÿæˆä¸­â€¦";
  startLoading();

  try{
    let payload = { prompt, options };
    if (file){
      const dataUrl = await toPngRgbaDataURL(file);
      payload.imageDataUrl = dataUrl;
    }

    const r = await fetch("/api/generate", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
    });

    const ct = r.headers.get("content-type") || "";
    if (!ct.includes("application/json")){
      const text = await r.text();
      throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ï¼ˆJSONä»¥å¤–ï¼‰ã€‚" + (text?.slice(0,120) || ""));
    }

    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }

    result.innerHTML = `<img class="gen" src="${j.image}" alt="ç”Ÿæˆç”»åƒ">`;
  }catch(e){
    err.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
  }finally{
    stopLoading();
    btn.disabled = false; btn.textContent = "ç”Ÿæˆ";
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","BIZ UDPGothic","Noto Sans JP",sans-serif; max-width:900px; margin:2rem auto; padding:1rem;}
    h1{display:flex; gap:.5rem; align-items:center; font-size:1.8rem;}
    h1::before{content:"ğŸ¨";}
    .row{display:flex; gap:.5rem; align-items:center; margin:.25rem 0;}
    input[type="text"]{flex:1; padding:.6rem; font-size:1rem;}
    select,button{padding:.55rem .7rem; font-size:.95rem; cursor:pointer;}
    .opts{display:flex; flex-wrap:wrap; gap:1rem; margin:.5rem 0 0;}
    .note{font-size:.9rem; color:#444; background:#fafafa; border:1px solid #eee; padding:.8rem; border-radius:.5rem; line-height:1.6;}
    .error{color:#b00020; margin-top:.5rem;}
    img{max-width:100%; margin-top:1rem; border:1px solid #ddd;}
    .progress{height:8px; background:#eee; border-radius:999px; overflow:hidden; margin:.5rem 0; display:none}
    .bar{height:100%; width:0%; background:#4a90e2; transition:width .25s}
    .loading{display:inline-flex; gap:.4rem; align-items:center; margin-left:.5rem; font-size:.9rem; color:#666}
    .dot{width:6px; height:6px; border-radius:50%; background:#999; animation:bubble 1s infinite alternate}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes bubble{from{transform:translateY(0)} to{transform:translateY(-5px)}}
  </style>
</head>
<body>
  <h1>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <!-- 1è¡Œç›®ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆå³å´ï¼‰-->
  <div class="row">
    <input id="prompt" type="text" placeholder="ä¾‹ï¼šå¯Œå£«å±±ã«ç™»ã‚‹çŒ« / äººç‰©å†™çœŸã¯â€œç¬‘é¡”ã§ä¼¼ã›ã¦ã€ã‚„ã‚„ã‚¢ãƒ‹ãƒ¡èª¿â€ãªã©">
    <button id="btn">ç”Ÿæˆ</button>
    <span id="spin" class="loading" style="display:none">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </span>
  </div>

  <!-- 2è¡Œç›®ï¼šä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆ + ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div class="row">
    <select id="preset">
      <option value="">ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</option>
      <option value="pixar">æŸ”ã‚‰ã‹ã„â€œæµ·å¤–ã‚¢ãƒ‹ãƒ¡æ˜ ç”»â€é¢¨ã€‚å¤§ãã‚ã®ç›®ãƒ»ä¸¸ã¿ã®ã‚ã‚‹é™°å½±ãƒ»æš–è‰²ã€‚</option>
      <option value="anime">æ—¥æœ¬ã‚¢ãƒ‹ãƒ¡èª¿ã€‚è¼ªéƒ­ãã£ãã‚Šã€è»½ã‚ã®é™°å½±ã€é®®ã‚„ã‹ãªé…è‰²ã€‚</option>
      <option value="watercolor">æ°´å½©ã‚¤ãƒ©ã‚¹ãƒˆèª¿ã€‚ç´™ã®è³ªæ„Ÿã€ã«ã˜ã¿ã€æ·¡ã„è‰²ã€‚</option>
      <option value="oil">æ²¹çµµé¢¨ã€‚åšå¡—ã‚Šã€ç­†è‡´æ„Ÿã€åŠ‡çš„ãªå…‰ã€‚</option>
      <option value="flat">ãƒ•ãƒ©ãƒƒãƒˆãƒãƒƒãƒ—ã€‚ç­‰å¹…ç·šã€ãƒ™ã‚¿å¡—ã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã€‚</option>
    </select>

    <input id="file" type="file" accept="image/*">
  </div>

  <!-- 3è¡Œç›®ï¼šäººç‰©å‘ã‘ ã¡ã‚‡ã„ç››ã‚Šã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
  <div class="opts">
    <label><input type="checkbox" id="enhance"> ã¡ã‚‡ã„ç››ã‚Šï¼ˆ+20%ã ã‘é›°å›²æ°—ã‚ˆãï¼‰</label>
    <label><input type="checkbox" id="smile"> è‡ªç„¶ãªç¬‘é¡”ã«ã™ã‚‹</label>
    <label><input type="checkbox" id="skin"> è‚Œãƒ»é«ªã‚’ãã‚Œã„ã«æ•´ãˆã‚‹ï¼ˆã‚„ã‚Šã™ããªã„ï¼‰</label>
    <label><input type="checkbox" id="keep"> æœ¬äººã®ç‰¹å¾´ã¯æ®‹ã™ï¼ˆåˆ¥äººåŒ–ã—ãªã„ï¼‰</label>
  </div>

  <div class="note" style="margin:.8rem 0;">
    <b>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æ³¨æ„</b><br>
    ä½¿ãˆã‚‹å½¢å¼ï¼šJPEG / PNG / WebPï¼ˆ<u>PNG ã¯ä¿å­˜ã®ä»•æ–¹ã«ã‚ˆã£ã¦å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™</u>ï¼‰<br>
    å¤±æ•—ä¾‹ï¼š<code>unsupported mimetype: application/octet-stream</code>ï¼ˆæ‹¡å¼µå­ã¯PNGã§ã‚‚ä¸­èº«ãŒç•°å¸¸ï¼‰ / <code>format must be RGBAï¼ˆé€æ˜æƒ…å ±ãªã—PNGï¼‰</code><br>
    è§£æ±ºæ³•ï¼šä¸€åº¦ã‚¹ãƒãƒ›/PCã®ç·¨é›†æ©Ÿèƒ½ã§é–‹ã„ã¦ã€Œ<b>åˆ¥åã§ä¿å­˜ â†’ PNG ã‚‚ã—ãã¯ JPEG</b>ã€ã«ã—ç›´ã™ã¨ç›´ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
  </div>

  <div class="progress" id="pg"><div class="bar" id="bar"></div></div>

  <div id="result"></div>
  <div id="err" class="error"></div>

<script>
/* ---------- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ•´å½¢ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ï¼‰ ---------- */
function buildPrompt(userText, opts){
  const lines = [];

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ï¼ˆå…ˆé ­ã¯ãã®ã¾ã¾ï¼‰
  if (userText) lines.push(userText);

  // ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆ
  const preset = {
    pixar: "æŸ”ã‚‰ã‹ã„æµ·å¤–ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã®ãƒ«ãƒƒã‚¯ã€‚å¤§ãã‚ã®ç›®ã€ä¸¸ã¿ã®ã‚ã‚‹å½¢çŠ¶ã€æš–è‰²å¯„ã‚Šã®ã‚«ãƒ©ãƒ¼ã€ã‚„ã•ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‚",
    anime: "æ—¥æœ¬ã‚¢ãƒ‹ãƒ¡èª¿ã€‚è¼ªéƒ­ç·šã¯ã¯ã£ãã‚Šã€é™°å½±ã¯æ§ãˆã‚ã€è‰²ã¯é®®ã‚„ã‹ã§ã‚¯ãƒªãƒ¼ãƒ³ã€ç›®ã¯ç”Ÿãç”Ÿãã¨ã€‚",
    watercolor: "æ°´å½©ç”»ã‚¿ãƒƒãƒã€‚ç´™ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã€ã«ã˜ã¿ã‚„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€æŸ”ã‚‰ã‹ãªé…è‰²ã€‚",
    oil: "æ²¹çµµé¢¨ã€‚åšå¡—ã‚Šã®ç­†è‡´ã€é‡åšãªé™°å½±ã€ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã€‚",
    flat: "ãƒ•ãƒ©ãƒƒãƒˆãƒãƒƒãƒ—ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢çŠ¶ã€ç­‰å¹…ç·šã€ãƒ™ã‚¿å¡—ã‚Šã€ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆé«˜ã‚ã€‚"
  }[opts.preset] || "";

  if (preset) lines.push(`ã‚¹ã‚¿ã‚¤ãƒ«: ${preset}`);

  // äººç‰©å‘ã‘â€œã¡ã‚‡ã„ç››ã‚Šâ€ã®æŸï¼ˆã‚„ã‚Šã™ãç¦æ­¢ã§å®‰å®šåŒ–ï¼‰
  const softRules = [];
  if (opts.enhance) softRules.push("å…¨ä½“ã‚’20%ã ã‘é­…åŠ›çš„ã«ï¼ˆæ¸…æ½”æ„Ÿãƒ»ãƒãƒ©ãƒ³ã‚¹ãƒ»å…‰ã®å½“ã¦æ–¹ã‚’å¾®èª¿æ•´ï¼‰ã€‚ã‚„ã‚Šã™ãç¦æ­¢ã€‚");
  if (opts.smile)   softRules.push("è‡ªç„¶ãªå¾®ç¬‘ã¿ã€‚æ­¯ã¯ä¸è‡ªç„¶ã«ç™½ãã—ãªã„ã€‚ç›®å°»ã¯å„ªã—ãã€‚");
  if (opts.skin)    softRules.push("è‚Œãƒ»é«ªã®è³ªæ„Ÿã‚’è»½ãæ•´ãˆã‚‹ã€‚è‚Œã¯ãƒ†ã‚«ã‚‰ã›ãªã„ã€æ¯›ç©´ã‚„ã‚·ãƒ¯ã¯æ®‹ã—ã¦ãƒªã‚¢ãƒ«ã•ã‚’ç¶­æŒã€‚");
  if (opts.keep)    softRules.push("æœ¬äººã®é¢å½±ãƒ»é¡”ã®éª¨æ ¼ãƒ»é«ªå‹ãƒ»è¼ªéƒ­ãƒ»ã»ãã‚ç­‰ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ç¶­æŒã€‚åˆ¥äººåŒ–ã—ãªã„ã€‚");
  if (softRules.length) lines.push("äººç‰©è£œæ­£æŒ‡ç¤º: " + softRules.join(" "));

  // ä»•ä¸Šã’ã®å…±é€šãƒ«ãƒ¼ãƒ«
  lines.push("å‡ºåŠ›ã¯é«˜è§£åƒåº¦ã€æ§‹å›³ã¯è¦‹æ „ãˆè‰¯ãã€è‰²ã¯ç ´ç¶»ã•ã›ãªã„ã€‚æ‰‹ã‚„æŒ‡ã®å½¢çŠ¶ã¯è‡ªç„¶ã«ã€‚");

  return lines.join("\n");
}

/* ---------- ãƒ•ãƒ­ãƒ³ãƒˆã®æŒ™å‹• ---------- */
const el = {
  prompt: document.getElementById("prompt"),
  preset: document.getElementById("preset"),
  file:    document.getElementById("file"),
  btn:     document.getElementById("btn"),
  spin:    document.getElementById("spin"),
  result:  document.getElementById("result"),
  err:     document.getElementById("err"),
  pg:      document.getElementById("pg"),
  bar:     document.getElementById("bar"),
  enhance: document.getElementById("enhance"),
  smile:   document.getElementById("smile"),
  skin:    document.getElementById("skin"),
  keep:    document.getElementById("keep")
};

function setBusy(b){
  el.btn.disabled = b;
  el.spin.style.display = b ? "inline-flex" : "none";
  el.pg.style.display = b ? "block" : "none";
  el.bar.style.width = b ? "25%" : "0%";
}

async function fileToDataURL(file){
  const buf = await file.arrayBuffer();
  const bin = new Uint8Array(buf);
  const b64 = btoa(Array.from(bin).map(b=>String.fromCharCode(b)).join(""));
  return `data:${file.type || "image/*"};base64,${b64}`;
}

document.getElementById("btn").addEventListener("click", async () => {
  el.err.textContent = "";
  el.result.innerHTML = "";

  const userText = el.prompt.value.trim();
  if(!userText){ el.err.textContent = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

  // â‘ ãƒ†ãƒ³ãƒ—ãƒ¬ã§æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åˆæˆ
  const finalPrompt = buildPrompt(userText, {
    preset : el.preset.value,
    enhance: el.enhance.checked,
    smile  : el.smile.checked,
    skin   : el.skin.checked,
    keep   : el.keep.checked
  });

  // â‘¡ç”»åƒï¼ˆä»»æ„ï¼‰
  let imageDataUrl = null;
  if (el.file.files && el.file.files[0]) {
    const f = el.file.files[0];

    // ç°¡å˜ãƒã‚§ãƒƒã‚¯ï¼šå£Šã‚ŒPNGå¯¾ç­–ï¼ˆapplication/octet-streamå›é¿ï¼‰
    if (!/^image\/(png|jpeg|webp)$/i.test(f.type)) {
      el.err.textContent = `ã“ã®ç”»åƒã®ç¨®é¡ï¼ˆ${f.type||"unknown"}ï¼‰ã¯æ‰±ãˆã¾ã›ã‚“ã€‚JPEG/PNG/WebP ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`;
      return;
    }
    imageDataUrl = await fileToDataURL(f);
  }

  // â‘¢é€ä¿¡
  try{
    setBusy(true);
    el.bar.style.width = "55%";

    const r = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt: finalPrompt,
        image: imageDataUrl || null
      })
    });

    el.bar.style.width = "85%";

    const j = await r.json();
    if(!r.ok){
      // ã‚¨ãƒ©ãƒ¼ã‚’ã‚ã‹ã‚Šã‚„ã™ã
      const msg = (j && j.error) ? String(j.error) : `HTTP ${r.status}`;
      el.err.innerHTML =
        `ã‚¨ãƒ©ãƒ¼ï¼š${msg.replaceAll("<","&lt;")}<br>
        <small>å¯¾å‡¦ã®ãƒ’ãƒ³ãƒˆï¼šç”»åƒã‚’ä¸€åº¦ã€Œåˆ¥åã§ä¿å­˜ â†’ JPEG/PNGã€ã«ã—ç›´ã™ã¨ç›´ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</small>`;
      return;
    }
    // è¡¨ç¤º
    el.result.innerHTML = `<img src="${j.image}" alt="ç”Ÿæˆç”»åƒ">`;
    el.bar.style.width = "100%";
  }catch(e){
    el.err.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š${e.message}`;
  }finally{
    setBusy(false);
    setTimeout(()=>{ el.pg.style.display="none"; }, 600);
  }
});
</script>
</body>
</html>

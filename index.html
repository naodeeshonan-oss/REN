<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>好きなイラストを作ろう</title>
<style>
  :root{ --bg:#fafafa; --card:#fff; --text:#222; --muted:#666; --border:#e5e5e5; }
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans JP",sans-serif; }
  .wrap{ max-width:980px; margin:36px auto; padding:0 16px; }
  h1{ font-size:24px; margin:0 0 16px; display:flex; gap:.5rem; align-items:center; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0; }
  label{ font-weight:600; display:block; margin:8px 0 6px; }
  input[type="text"], textarea, select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  textarea{ min-height:120px; font-family:inherit; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .muted{ color:var(--muted); font-size:12px; line-height:1.5; }
  .actions{ display:flex; gap:8px; align-items:center; margin-top:16px; }
  button{ cursor:pointer; padding:12px 16px; border:1px solid var(--border); background:#111; color:#fff; border-radius:10px; font-weight:600; font-size:14px; width:100%; }
  button[disabled]{ opacity:.6; cursor:wait; }
  .out{ display:grid; place-items:center; min-height:280px; border:1px dashed var(--border); border-radius:12px; background:#fff; }
  .out img{ max-width:100%; height:auto; border-radius:12px; }
  .small{ font-size:12px; }
  .checks label{ font-weight:400; display:flex; align-items:center; gap:.5rem; margin:6px 0; }
  .pill{ display:inline-block; padding:4px 8px; background:#f4f4f4; border-radius:999px; font-size:12px; }
  @media (max-width:720px){ .row{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>🎨 好きなイラストを作ろう</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>写真を選んでください（任意：選ばない＝テキストから）</label>
        <input id="file" type="file" accept="image/*" />
        <div id="fileInfo" class="muted" style="margin-top:6px;"></div>
      </div>
      <div>
        <label>作風プリセット</label>
        <select id="preset">
          <option value="1">① かわいい・ちびキャラ風</option>
          <option value="2">② 大人っぽいアニメ調（スッキリ）</option>
          <option value="3">③ カジュアル／ポップ・ストリート風</option>
        </select>
      </div>
    </div>

    <label style="margin-top:12px;">（任意）追加したい指示があれば入力</label>
    <textarea id="prompt" placeholder="例：笑顔でピースサイン、上半身、白背景など"></textarea>

    <div class="row" style="margin-top:12px;">
      <div class="card" style="margin:0;">
        <div style="font-weight:600; margin-bottom:8px;">補助チェック</div>
        <div class="checks">
          <label><input id="bgTransparent" type="checkbox" /> 背景を透過する</label>
          <label>背景を変更：
            <select id="bgPreset">
              <option value="">（変更しない＝白）</option>
              <option value="solid white background">真っ白な背景</option>
              <option value="simple pastel background">淡いパステルの簡素な背景</option>
            </select>
          </label>
          <label><input id="brightnessUp" type="checkbox" /> 明るさを少し上げる</label>
          <label><input id="moodBoost" type="checkbox" /> ちょっと雰囲気UP（+20%）</label>
        </div>
        <div class="muted">※ 生成は <span class="pill">1枚固定</span> ／ 高精細写真は自動で圧縮して送信します</div>
      </div>

      <div class="card" style="margin:0;">
        <div class="actions">
          <button id="genBtn">生成する（1枚固定）</button>
        </div>
        <div id="status" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="out" id="out"><span class="muted">ここに結果が表示されます</span></div>
  </div>

  <div class="muted small">
    ※ ①はちびキャラ、②は大人アニメ、③はポップ・ストリート。<br/>
    ※ 「本人そっくり」を優先、白背景ベース、NG（ネガティブ）も自動で付与します。<br/>
  </div>
</div>

<script>
/* ==========================================================
   画像は必ず送信前に圧縮（長辺 1024px / JPEG 品質 0.85）
   これで 413(Entity Too Large) を防ぎ、転送・コストを最適化
   ========================================================== */
async function resizeToDataURL(file, maxSide = 1024, quality = 0.85) {
  const readAsImage = (f) => new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => resolve({ img, src: fr.result });
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(f);
  });

  // HEIC等はブラウザによって読み込み不可→そのまま送る（サーバで弾かれても原因が分かる）
  try {
    const { img } = await readAsImage(file);
    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSide / Math.max(w, h));
    const dstW = Math.max(1, Math.round(w * scale));
    const dstH = Math.max(1, Math.round(h * scale));
    const canvas = document.createElement("canvas");
    canvas.width = dstW; canvas.height = dstH;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, dstW, dstH);
    // PNGは重くなるので既定はJPEG。背景透過チェック時のみPNG化。
    const bgTransparent = document.getElementById('bgTransparent')?.checked;
    return bgTransparent
      ? canvas.toDataURL("image/png")
      : canvas.toDataURL("image/jpeg", quality);
  } catch (e) {
    // フォールバック：そのままdataURL化（最後の砦）
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
}

// ファイル選択情報の表示
const fileEl = document.getElementById('file');
const fileInfoEl = document.getElementById('fileInfo');
if (fileEl) {
  fileEl.addEventListener('change', () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) { fileInfoEl.textContent = ''; return; }
    fileInfoEl.textContent = `選択：${f.name}（${(f.size/1024/1024).toFixed(2)} MB） → 送信前に自動圧縮します`;
  });
}

// 生成処理
const btn = document.getElementById('genBtn');
btn.addEventListener('click', async () => {
  const status = document.getElementById('status');
  const out = document.getElementById('out');
  try {
    btn.disabled = true;
    btn.textContent = '生成中…（1枚固定）';
    status.textContent = '画像と指示を送信しています…';

    // UI 値取得
    const preset  = document.getElementById('preset').value;   // 1 / 2 / 3
    const prompt  = document.getElementById('prompt').value || '';
    const bgTransparent = document.getElementById('bgTransparent').checked;
    const bgPreset = document.getElementById('bgPreset').value;
    const brightnessUp = document.getElementById('brightnessUp').checked;
    const moodBoost = document.getElementById('moodBoost').checked;

    // 圧縮 dataURL 作成（未選択なら null）
    const f = fileEl.files && fileEl.files[0];
    let imageDataUrl = null;
    if (f) {
      imageDataUrl = await resizeToDataURL(f, 1024, 0.85);
    }

    const body = {
      prompt,
      preset,
      imageDataUrl, // nullならtxt2img、ありならimg2img（“そっくり優先” 自動付与）
      options: { bgTransparent, bgPreset, brightnessUp, moodBoost }
    };

    const r = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);

    out.innerHTML = `<img alt="result" src="${data.image}">`;
    status.textContent = '完了（1枚）';
  } catch (e) {
    status.textContent = `失敗：${e.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = '生成する（1枚固定）';
  }
});
</script>
</body>
</html>

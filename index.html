<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
  <style>
    :root{--w:820px}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; line-height:1.6; margin:0; background:#fff;}
    main{max-width:var(--w); margin:2rem auto; padding:0 1rem;}
    h1{display:flex; gap:.6rem; align-items:center; font-size:clamp(20px,4vw,32px); margin:.2rem 0 1rem}
    h1:before{content:"ğŸ¨"}
    .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    input[type=text]{flex:1; min-width:260px; padding:.6rem .7rem; font-size:1rem}
    button{padding:.55rem .9rem; font-size:1rem; cursor:pointer}
    .opts{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:.35rem .9rem; margin:.6rem 0 1rem}
    .note{background:#f7f7f7; border:1px solid #e5e5e5; padding:.8rem; border-radius:.4rem; font-size:.95rem}
    #result img{max-width:100%; display:block; margin:1rem 0; border:1px solid #ddd}
    .err{color:#c00; margin-top:.6rem}
    .pill{display:inline-flex; gap:.35rem; align-items:center; border:1px solid #ddd; padding:.35rem .55rem; border-radius:999px; background:#fff}
    input[type=file]{display:none}
    label[for=up]{cursor:pointer}
    .spinner{display:inline-block; width:20px; height:20px; border-radius:50%; border:3px solid #ddd; border-top-color:#333; animation:spin 1s linear infinite; vertical-align:-5px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{font-size:.92rem; color:#555}
  </style>
</head>
<body>
<main>
  <h1>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <div class="row" style="gap:.5rem  .5rem;">
    <input id="prompt" type="text" placeholder="ä¾‹ï¼šå¯Œå£«å±±ã«ç™»ã‚‹çŒ«ï¼äººç‰©å†™çœŸã¯â€œç¬‘é¡”ã§ä¼¼ã›ã¦â€ ãªã©">
    <button id="go">ç”Ÿæˆ</button>
  </div>

  <div class="row" style="margin:.35rem 0 0;">
    <div class="pill">
      <label for="preset">ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</label>
      <select id="preset">
        <option value="">â€” ãªã— â€”</option>
        <option value="anime-soft">ã‚„ã•ã—ã„ã‚¢ãƒ‹ãƒ¡èª¿</option>
        <option value="pixar-soft">ãƒ”ã‚¯ã‚µãƒ¼é¢¨ï¼ˆæ§ãˆã‚ï¼‰</option>
        <option value="ghibli-soft">ã‚¸ãƒ–ãƒªé¢¨ï¼ˆæ§ãˆã‚ï¼‰</option>
        <option value="watercolor">æ°´å½©ã‚¿ãƒƒãƒ</option>
      </select>
    </div>

    <div class="pill">
      <label for="up">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      <input id="up" type="file" accept="image/*">
      <span id="fname" class="hint">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
    </div>
  </div>

  <div class="opts">
    <label><input id="lite"  type="checkbox"> ã¡ã‚‡ã„ç››ã‚Šï¼ˆ+20%ã ã‘é›°å›²æ°—ã‚ˆãï¼‰</label>
    <label><input id="smile" type="checkbox"> è‡ªç„¶ãªç¬‘é¡”ã«ã™ã‚‹</label>
    <label><input id="clean" type="checkbox" checked> è‚Œãƒ»é«ªã‚’ãã‚Œã„ã«æ•´ãˆã‚‹ï¼ˆã‚„ã‚Šã™ããªã„ï¼‰</label>
    <label><input id="lockFace" type="checkbox" checked> æœ¬äººã®ç‰¹å¾´ã¯å¼·ãæ®‹ã™ï¼ˆåˆ¥äººåŒ–ã•ã›ãªã„ï¼‰</label>
  </div>

  <div class="note">
    <b>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æ³¨æ„</b><br>
    ä½¿ãˆã‚‹å½¢å¼ï¼šJPEG / PNG / WebPï¼ˆ<u>PNG ã¯ä¿å­˜ã®ä»•æ–¹ã«ã‚ˆã£ã¦å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™</u>ï¼‰<br>
    å¤±æ•—ä¾‹ï¼š<code>unsupported mimetype: application/octet-stream</code>ï¼ˆæ‹¡å¼µå­ãŒ PNG ã§ã‚‚ä¸­èº«ãŒç•°å¸¸ï¼‰ï¼
    <code>format must be RGBA</code>ï¼ˆé€æ˜æƒ…å ±ãªã— PNGï¼‰<br>
    è§£æ±ºæ³•ï¼šä¸€åº¦ã‚¹ãƒãƒ›/PCã®ç·¨é›†æ©Ÿèƒ½ã§é–‹ã„ã¦ã€Œ<b>åˆ¥åã§ä¿å­˜ â†’ PNG ã‚‚ã—ãã¯ JPEG</b>ã€ã«ã—ç›´ã™ã¨ç›´ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
  </div>

  <div id="result"></div>
  <div id="err" class="err"></div>
</main>

<script>
const $ = id => document.getElementById(id);
const btn = $("go"), file = $("up"), fname = $("fname"), result = $("result"), err = $("err");

file.addEventListener("change", () => {
  fname.textContent = file.files?.[0]?.name || "é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
});

async function fileToBase64(f){
  if(!f) return null;
  const buf = await f.arrayBuffer();
  // ã“ã“ã§ base64 æ–‡å­—åˆ—ã¸
  let binary = "";
  const bytes = new Uint8Array(buf);
  const len = bytes.byteLength;
  for (let i=0; i<len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary); // dataURL ã¯ä»˜ã‘ãšã€ä¸­èº«ã ã‘ã‚’é€ã‚‹
}

btn.addEventListener("click", async () => {
  err.textContent = "";
  result.innerHTML = "";

  const prompt = $("prompt").value.trim();
  if(!prompt){ err.textContent = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> ç”Ÿæˆä¸­â€¦';

  try{
    const img = file.files?.[0] ? {
      mime: file.files[0].type || "image/jpeg",
      name: file.files[0].name || "upload.jpg",
      b64: await fileToBase64(file.files[0])
    } : null;

    const body = {
      prompt,
      options:{
        preset: $("preset").value,
        lite: $("lite").checked,
        smile: $("smile").checked,
        clean: $("clean").checked,
        lockFace: $("lockFace").checked
      },
      image: img
    };

    const r = await fetch("/api/generate",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const j = await r.json().catch(()=> ({}));
    if(!r.ok){
      err.textContent = "ã‚¨ãƒ©ãƒ¼: " + (j.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      return;
    }
    result.innerHTML = `<img alt="ç”Ÿæˆç”»åƒ" src="${j.image}">`;
  }catch(e){
    err.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message;
  }finally{
    btn.disabled = false; btn.textContent = "ç”Ÿæˆ";
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>好きなイラストを作ろう</title>
  <style>
    :root { --fg:#222; --muted:#666; --accent:#444; }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,Meiryo,sans-serif;
         color:var(--fg); max-width:820px; margin:2rem auto; padding:1rem;}
    h1{display:flex; gap:.5rem; align-items:center; font-size:clamp(1.4rem,3vw,2rem);}
    h1::before{content:"🎨";}
    .row{display:flex; gap:.5rem; align-items:center}
    input[type="text"]{flex:1; padding:.7rem .8rem; font-size:1rem; border:1px solid #ccc; border-radius:.5rem;}
    input[type="file"]{font-size:.95rem;}
    button{padding:.65rem .9rem; font-size:1rem; border:1px solid #ccc; border-radius:.5rem; background:#fff; cursor:pointer;}
    button[disabled]{opacity:.6; cursor:default;}
    .note{margin:1rem 0; font-size:.92rem; color:var(--muted); background:#f7f7f7; border:1px solid #eee; border-radius:.6rem; padding:.8rem 1rem; line-height:1.7;}
    .note b{color:#000;}
    .error{color:#b00020; margin:.6rem 0;}
    img.gen{max-width:100%; margin-top:1rem; border:1px solid #ddd; border-radius:.5rem}

    /* ローディング（干支が歩く） */
    .loading {
      display:none; align-items:center; gap:.6rem; margin:.6rem 0 0;
      color:#555; font-size:.95rem;
    }
    .walklane {
      position:relative; width:120px; height:28px; overflow:hidden;
      border:1px solid #eee; border-radius:999px; background:#fafafa;
    }
    .animal {
      position:absolute; top:50%; transform:translate(-100%, -50%);
      font-size:22px; line-height:1;
      animation: walk 1.6s linear infinite;
    }
    @keyframes walk {
      0%{ transform:translate(-100%, -50%); }
      100%{ transform:translate(120px, -50%); }
    }
  </style>
</head>
<body>
  <h1>好きなイラストを作ろう</h1>

  <div class="row" style="margin:.6rem 0 0">
    <input id="prompt" type="text" placeholder="例: 富士山に登る猫 / この写真をディズニー風に など" />
    <button id="btn">生成</button>
  </div>

  <div style="margin:.6rem 0 .2rem">
    <input id="file" type="file" accept="image/*">
  </div>

  <div class="note">
    <div><b>画像を選ぶと「編集モード」</b>、画像なしは「新規作成」です。</div>
    <ul style="margin:.3rem 0 .2rem 1.2rem; padding:0;">
      <li>使える形式：<b>JPEG / PNG / WebP</b></li>
      <li>編集モードでは、<b>内部でPNG（RGBA）に自動変換</b>します（PNGでも保存の仕方次第で失敗することがあります）</li>
      <li>よくある失敗例：<code>unsupported mimetype: application/octet-stream</code>（拡張子はPNGでも中身が異常） / <code>format must be RGBA</code>（透明情報なしPNG）</li>
      <li>うまくいかない時は、一度スマホ/PCの編集機能で開いて <b>「別名で保存 → PNG もしくは JPEG」</b> に直すと直ることが多いです</li>
    </ul>
  </div>

  <div class="loading" id="loading">
    <div class="walklane"><div class="animal" id="animal">🐭</div></div>
    <span>生成中…（少しお待ちください）</span>
  </div>

  <div id="err" class="error"></div>
  <div id="result"></div>

<script>
/* 干支（右方向に歩きます） */
const zodiac = ["🐭","🐮","🐯","🐰","🐲","🐍","🐴","🐑","🐵","🐔","🐶","🐗"];
let zi = 0, zTimer=null;
function startLoading(){
  const box = document.getElementById("loading");
  const a = document.getElementById("animal");
  box.style.display = "flex";
  a.style.animation = "none"; a.offsetHeight; a.style.animation = null; // リセット
  a.textContent = zodiac[zi % zodiac.length];
  zTimer = setInterval(()=>{
    zi++; a.textContent = zodiac[zi % zodiac.length];
    a.style.animation = "none"; a.offsetHeight; a.style.animation = null;
  }, 900);
}
function stopLoading(){
  const box = document.getElementById("loading");
  box.style.display = "none";
  if (zTimer){ clearInterval(zTimer); zTimer=null; }
}

/* 画像をPNG(RGBA)に変換＋縮小（長辺1200px） */
async function toPngRgbaDataURL(file){
  const okTypes = ["image/jpeg","image/png","image/webp"];
  const mime = file.type || "";
  if (!okTypes.includes(mime)) throw new Error("この画像形式は扱えません。JPEG/PNG/WebP を使ってください。");
  const img = await new Promise((res,rej)=>{
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = ()=>{ URL.revokeObjectURL(url); res(im); };
    im.onerror = ()=>{ URL.revokeObjectURL(url); rej(new Error("画像を読み込めませんでした")); };
    // iOSの向き問題を避けるため crossOrigin 空指定
    im.crossOrigin = "";
    im.src = url;
  });
  // リサイズ
  const maxSide = 1200;
  let {width:w, height:h} = img;
  const scale = Math.min(1, maxSide / Math.max(w,h));
  const cw = Math.round(w * scale), ch = Math.round(h * scale);
  const cv = document.createElement("canvas");
  cv.width = cw; cv.height = ch;
  const ctx = cv.getContext("2d");
  // RGBAキャンバスに描画＝常にアルファ付きPNGへ
  ctx.drawImage(img, 0, 0, cw, ch);
  return cv.toDataURL("image/png"); // data:image/png;base64,...
}

/* 生成 */
document.getElementById("btn").addEventListener("click", generate);
async function generate(){
  const btn = document.getElementById("btn");
  const prompt = document.getElementById("prompt").value.trim();
  const file = document.getElementById("file").files[0];
  const result = document.getElementById("result");
  const err = document.getElementById("err");
  err.textContent = ""; result.innerHTML = "";

  if(!prompt){ err.textContent = "プロンプトを入力してください。"; return; }

  btn.disabled = true; btn.textContent = "生成中…";
  startLoading();
  try{
    let payload = { prompt };
    if (file){
      // 編集モード：JPEG/PNG/WebP → PNG(RGBA)のdataURLに変換して送る
      const dataUrl = await toPngRgbaDataURL(file);
      payload.imageDataUrl = dataUrl;
    }

    const r = await fetch("/api/generate", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
    });

    // JSON以外（HTMLエラー等）が返るケースに備える
    const ct = r.headers.get("content-type") || "";
    if (!ct.includes("application/json")){
      const text = await r.text();
      throw new Error("サーバーからの応答が不正です（JSON以外）。" + (text?.slice(0,120) || ""));
    }

    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "エラーが発生しました"); }
    result.innerHTML = `<img class="gen" src="${j.image}" alt="生成画像">`;
  }catch(e){
    err.textContent = "エラー: " + e.message;
  }finally{
    stopLoading();
    btn.disabled = false; btn.textContent = "生成";
  }
}
</script>
</body>
</html>

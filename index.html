<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</title>
<style>
  :root{ --bg:#fafafa; --card:#fff; --text:#222; --muted:#666; --border:#e5e5e5; }
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans JP",sans-serif; }
  .wrap{ max-width:980px; margin:36px auto; padding:0 16px; }
  h1{ font-size:24px; margin:0 0 16px; display:flex; gap:.5rem; align-items:center; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0; }
  label{ font-weight:600; display:block; margin:8px 0 6px; }
  input[type="text"], textarea, select{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px; }
  textarea{ min-height:120px; font-family:inherit; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .muted{ color:var(--muted); font-size:12px; line-height:1.5; }
  .actions{ display:flex; gap:8px; align-items:center; margin-top:16px; }
  button{ cursor:pointer; padding:12px 16px; border:1px solid var(--border); background:#111; color:#fff; border-radius:10px; font-weight:600; font-size:14px; width:100%; }
  button[disabled]{ opacity:.6; cursor:wait; }
  .out{ display:grid; place-items:center; min-height:280px; border:1px dashed var(--border); border-radius:12px; background:#fff; }
  .out img{ max-width:100%; height:auto; border-radius:12px; }
  .small{ font-size:12px; }
  .checks label{ font-weight:400; display:flex; align-items:center; gap:.5rem; margin:6px 0; }
  .pill{ display:inline-block; padding:4px 8px; background:#f4f4f4; border-radius:999px; font-size:12px; }
  @media (max-width:720px){ .row{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¨ å¥½ããªã‚¤ãƒ©ã‚¹ãƒˆã‚’ä½œã‚ã†</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆä»»æ„ï¼šé¸ã°ãªã„ï¼ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ï¼‰</label>
        <input id="file" type="file" accept="image/*" />
        <div id="fileInfo" class="muted" style="margin-top:6px;"></div>
      </div>
      <div>
        <label>ä½œé¢¨ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
        <select id="preset">
          <option value="1">â‘  ã‹ã‚ã„ã„ãƒ»ã¡ã³ã‚­ãƒ£ãƒ©é¢¨</option>
          <option value="2">â‘¡ å¤§äººã£ã½ã„ã‚¢ãƒ‹ãƒ¡èª¿ï¼ˆã‚¹ãƒƒã‚­ãƒªï¼‰</option>
          <option value="3">â‘¢ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ãƒãƒƒãƒ—ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆé¢¨</option>
        </select>
      </div>
    </div>

    <label style="margin-top:12px;">ï¼ˆä»»æ„ï¼‰è¿½åŠ ã—ãŸã„æŒ‡ç¤ºãŒã‚ã‚Œã°å…¥åŠ›</label>
    <textarea id="prompt" placeholder="ä¾‹ï¼šç¬‘é¡”ã§ãƒ”ãƒ¼ã‚¹ã‚µã‚¤ãƒ³ã€ä¸ŠåŠèº«ã€ç™½èƒŒæ™¯ãªã©"></textarea>

    <div class="row" style="margin-top:12px;">
      <div class="card" style="margin:0;">
        <div style="font-weight:600; margin-bottom:8px;">è£œåŠ©ãƒã‚§ãƒƒã‚¯</div>
        <div class="checks">
          <label><input id="bgTransparent" type="checkbox" /> èƒŒæ™¯ã‚’é€éã™ã‚‹</label>
          <label>èƒŒæ™¯ã‚’å¤‰æ›´ï¼š
            <select id="bgPreset">
              <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼ç™½ï¼‰</option>
              <option value="solid white background">çœŸã£ç™½ãªèƒŒæ™¯</option>
              <option value="simple pastel background">æ·¡ã„ãƒ‘ã‚¹ãƒ†ãƒ«ã®ç°¡ç´ ãªèƒŒæ™¯</option>
            </select>
          </label>
          <label><input id="brightnessUp" type="checkbox" /> æ˜ã‚‹ã•ã‚’å°‘ã—ä¸Šã’ã‚‹</label>
          <label><input id="moodBoost" type="checkbox" /> ã¡ã‚‡ã£ã¨é›°å›²æ°—UPï¼ˆ+20%ï¼‰</label>
        </div>
        <div class="muted">â€» ç”Ÿæˆã¯ <span class="pill">1æšå›ºå®š</span> ï¼ é«˜ç²¾ç´°å†™çœŸã¯è‡ªå‹•ã§åœ§ç¸®ã—ã¦é€ä¿¡ã—ã¾ã™</div>
      </div>

      <div class="card" style="margin:0;">
        <div class="actions">
          <button id="genBtn">ç”Ÿæˆã™ã‚‹ï¼ˆ1æšå›ºå®šï¼‰</button>
        </div>
        <div id="status" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="out" id="out"><span class="muted">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span></div>
  </div>

  <div class="muted small">
    â€» â‘ ã¯ã¡ã³ã‚­ãƒ£ãƒ©ã€â‘¡ã¯å¤§äººã‚¢ãƒ‹ãƒ¡ã€â‘¢ã¯ãƒãƒƒãƒ—ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆã€‚<br/>
    â€» ã€Œæœ¬äººãã£ãã‚Šã€ã‚’å„ªå…ˆã€ç™½èƒŒæ™¯ãƒ™ãƒ¼ã‚¹ã€NGï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ï¼‰ã‚‚è‡ªå‹•ã§ä»˜ä¸ã—ã¾ã™ã€‚<br/>
  </div>
</div>

<script>
/* ==========================================================
   ç”»åƒã¯å¿…ãšé€ä¿¡å‰ã«åœ§ç¸®ï¼ˆé•·è¾º 1024px / JPEG å“è³ª 0.85ï¼‰
   ã“ã‚Œã§ 413(Entity Too Large) ã‚’é˜²ãã€è»¢é€ãƒ»ã‚³ã‚¹ãƒˆã‚’æœ€é©åŒ–
   ========================================================== */
async function resizeToDataURL(file, maxSide = 1024, quality = 0.85) {
  const readAsImage = (f) => new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => resolve({ img, src: fr.result });
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(f);
  });

  // HEICç­‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦èª­ã¿è¾¼ã¿ä¸å¯â†’ãã®ã¾ã¾é€ã‚‹ï¼ˆã‚µãƒ¼ãƒã§å¼¾ã‹ã‚Œã¦ã‚‚åŸå› ãŒåˆ†ã‹ã‚‹ï¼‰
  try {
    const { img } = await readAsImage(file);
    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSide / Math.max(w, h));
    const dstW = Math.max(1, Math.round(w * scale));
    const dstH = Math.max(1, Math.round(h * scale));
    const canvas = document.createElement("canvas");
    canvas.width = dstW; canvas.height = dstH;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, dstW, dstH);
    // PNGã¯é‡ããªã‚‹ã®ã§æ—¢å®šã¯JPEGã€‚èƒŒæ™¯é€éãƒã‚§ãƒƒã‚¯æ™‚ã®ã¿PNGåŒ–ã€‚
    const bgTransparent = document.getElementById('bgTransparent')?.checked;
    return bgTransparent
      ? canvas.toDataURL("image/png")
      : canvas.toDataURL("image/jpeg", quality);
  } catch (e) {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãã®ã¾ã¾dataURLåŒ–ï¼ˆæœ€å¾Œã®ç ¦ï¼‰
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæƒ…å ±ã®è¡¨ç¤º
const fileEl = document.getElementById('file');
const fileInfoEl = document.getElementById('fileInfo');
if (fileEl) {
  fileEl.addEventListener('change', () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) { fileInfoEl.textContent = ''; return; }
    fileInfoEl.textContent = `é¸æŠï¼š${f.name}ï¼ˆ${(f.size/1024/1024).toFixed(2)} MBï¼‰ â†’ é€ä¿¡å‰ã«è‡ªå‹•åœ§ç¸®ã—ã¾ã™`;
  });
}

// ç”Ÿæˆå‡¦ç†
const btn = document.getElementById('genBtn');
btn.addEventListener('click', async () => {
  const status = document.getElementById('status');
  const out = document.getElementById('out');
  try {
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­â€¦ï¼ˆ1æšå›ºå®šï¼‰';
    status.textContent = 'ç”»åƒã¨æŒ‡ç¤ºã‚’é€ä¿¡ã—ã¦ã„ã¾ã™â€¦';

    // UI å€¤å–å¾—
    const preset  = document.getElementById('preset').value;   // 1 / 2 / 3
    const prompt  = document.getElementById('prompt').value || '';
    const bgTransparent = document.getElementById('bgTransparent').checked;
    const bgPreset = document.getElementById('bgPreset').value;
    const brightnessUp = document.getElementById('brightnessUp').checked;
    const moodBoost = document.getElementById('moodBoost').checked;

    // åœ§ç¸® dataURL ä½œæˆï¼ˆæœªé¸æŠãªã‚‰ nullï¼‰
    const f = fileEl.files && fileEl.files[0];
    let imageDataUrl = null;
    if (f) {
      imageDataUrl = await resizeToDataURL(f, 1024, 0.85);
    }

    const body = {
      prompt,
      preset,
      imageDataUrl, // nullãªã‚‰txt2imgã€ã‚ã‚Šãªã‚‰img2imgï¼ˆâ€œãã£ãã‚Šå„ªå…ˆâ€ è‡ªå‹•ä»˜ä¸ï¼‰
      options: { bgTransparent, bgPreset, brightnessUp, moodBoost }
    };

    const r = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);

    out.innerHTML = `<img alt="result" src="${data.image}">`;
    status.textContent = 'å®Œäº†ï¼ˆ1æšï¼‰';
  } catch (e) {
    status.textContent = `å¤±æ•—ï¼š${e.message}`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'ç”Ÿæˆã™ã‚‹ï¼ˆ1æšå›ºå®šï¼‰';
  }
});
</script>
</body>
</html>
